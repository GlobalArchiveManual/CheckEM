---
title: "Checking habitat data exported from TransectMeasure"
author: "Claude Spencer & Brooke Gibbons"
date: "2023-11-12"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Checking habitat data exported from TransectMeasure}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = 'C:/Users/00104220/GL/CheckEM')
knitr::opts_knit$set(root.dir = 'C:/GitHub/CheckEMV2')
```

This guide documents the necessary steps to take raw data exported from TransectMeasure, and format it into 

Load the necessary libraries
```{r, results='hide', warning=FALSE, message=FALSE}
library(devtools)
library(CheckEM)
# devtools::load_all("./")
library(tidyverse)
library(ggplot2)
library(ggbeeswarm)
# library(leaflet) # This is erroring due to some conflict with checkem
library(leaflet.minicharts)
library(RColorBrewer)
library(todor)
```
Set the study name
```{r}
name <- "example-bruv-workflow"
```
Load and format metadata using the CheckEM function 'read_metadata'
```{r}
metadata <- read_metadata("1. Example R workflows (scripts to download)/data/raw/") %>%
    dplyr::select(campaignid, sample, longitude_dd, latitude_dd, date_time, location, site, depth, successful_count, successful_length, successful_habitat_forward, successful_habitat_backward) %>%
  glimpse()

saveRDS(metadata, file = paste0("1. Example R workflows (scripts to download)/data/tidy/", name, "_Metadata.rds"))
```
Read in the points data exported from Transect Measure, and then filter this into 2 dataframes for relief and habitat annotations
```{r}
points <- read_TM("1. Example R workflows (scripts to download)/data/raw/",
                               sample = "opcode")

habitat <- points %>%
  dplyr::filter(relief_annotated %in% "no") %>%
  dplyr::select(campaignid, sample, starts_with("level"), scientific, caab_code) %>%
  glimpse()

relief <- points %>%
  dplyr::filter(relief_annotated %in% "yes") %>%
  dplyr::select(campaignid, sample, starts_with("level"), scientific, caab_code) %>%
  glimpse()
```
Carry out some basic checks on the number of annotations per image
```{r}
num.points <- 20

wrong.points.habitat <- habitat %>%
  group_by(campaignid, sample) %>%
  summarise(points.annotated = n()) %>%
  left_join(metadata) %>%
  dplyr::mutate(expected = case_when(successful_habitat_forward %in% "Yes" & successful_habitat_backward %in% "Yes" ~ num.points * 2, successful_habitat_forward %in% "Yes" & successful_habitat_backward %in% "No" ~ num.points * 1, successful_habitat_forward %in% "No" & successful_habitat_backward %in% "Yes" ~ num.points * 1, successful_habitat_forward %in% "No" & successful_habitat_backward %in% "No" ~ num.points * 0)) %>%
  dplyr::filter(!points.annotated == expected) %>%
  glimpse()

wrong.points.relief <- relief %>%
  group_by(campaignid, sample) %>%
  summarise(points.annotated = n()) %>%
  left_join(metadata) %>%
  dplyr::mutate(expected = case_when(successful_habitat_forward %in% "Yes" & successful_habitat_backward %in% "Yes" ~ num.points * 2, successful_habitat_forward %in% "Yes" & successful_habitat_backward %in% "No" ~ num.points * 1, successful_habitat_forward %in% "No" & successful_habitat_backward %in% "Yes" ~ num.points * 1, successful_habitat_forward %in% "No" & successful_habitat_backward %in% "No" ~ num.points * 0)) %>%
  dplyr::filter(!points.annotated == expected) %>%
  glimpse()

habitat.missing.metadata <- anti_join(habitat, metadata, by = c("campaignid", "sample")) %>%
  glimpse()

metadata.missing.habitat <- anti_join(metadata, habitat, by = c("campaignid", "sample")) %>%
  glimpse()
```
Tidy and save the habitat data by joining with the complete schema file that is loaded with the CheckEM package
```{r}
schema <- schema %>%
  dplyr::select(-c(parent_caab, qualifiers)) %>%
  glimpse()

tidy.habitat <- habitat %>%
  dplyr::mutate(number = 1) %>%
  left_join(schema) %>%
  dplyr::select(campaignid, sample, number, starts_with("level"), family, genus, species) %>%
  dplyr::filter(!level_2 %in% c("","Unscorable", NA)) %>%
  group_by(campaignid, sample, across(starts_with("level")), family, genus, species) %>%
  dplyr::tally(number, name = "number") %>%
  ungroup() %>%
  dplyr::select(campaignid, sample, level_1, everything()) %>%
  glimpse()

saveRDS(tidy.habitat, file = paste0("1. Example R workflows (scripts to download)/data/staging/", name, "_Habitat.rds"))
```
Tidy and save the relief data by joining with the complete schema file that is loaded with the CheckEM package
```{r}
tidy.relief <- relief %>% # TODO join this with schema
  dplyr::filter(!level_2 %in% c("","Unscorable", NA)) %>%
  dplyr::mutate(number = 1) %>%
  left_join(schema) %>%
  group_by(campaignid, sample, across(starts_with("level")), caab_code) %>%
  dplyr::tally(number, name = "number") %>%
  ungroup() %>%                                                          glimpse()

saveRDS(tidy.relief, file = paste0("1. Example R workflows (scripts to download)/data/staging/", name, "_Relief.rds"))
```
