---
title: "Checking fish data exported from EventMeasure"
author: "Claude Spencer & Brooke Gibbons"
date: "2023-11-13"
output:
  html_vignette:
    toc: true
    code_folding: hide
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Checking fish data exported from EventMeasure}
  %\VignetteEncoding{UTF-8}
---

This script documents the necessary steps to take raw data exported from EventMeasure, check for any errors in the annotation and format it into tidy data. You are required to also have a GlobalArchive format metadata file "*_Metadata.csv".

# R set up
Load the necessary libraries.

```{r libraries, results='hide', warning=FALSE, message=FALSE}
library(devtools)
# devtools::install_github("GlobalArchiveManual/CheckEM") # Use this to install the CheckEM package if you have not already done so
library(CheckEM)
library(tidyverse)
library(googlesheets4)
library(sf)
library(terra)
library(here)
```

Set the study name.

```{r study-name}
name <- "example-bruv-workflow"
```

# Read in and format the metadata
Load and tidy the metadata. If you have already completed this step while checking your habitat data, then you can skip these next two chunks of code and simply read in the metadata (see below).

```{r load-metadata}
metadata <- read_metadata(here::here("r-workflows/data/raw/")) %>%
  dplyr::select(campaignid, sample, longitude_dd, latitude_dd, date_time, location, site, depth, successful_count, successful_length, successful_habitat_forward, successful_habitat_backward) %>%
  glimpse()
```

Save the metadata as an R data file (this creates a lighter file than saving as a .csv or similar).

```{r save-metadata}
saveRDS(metadata, file = here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```

Load metadata if you have already exported in the 'check-habitat' scripts. If you have just loaded and saved the metadata, then you can skip this chunk of code.

```{r tidy-metadata}
metadata <- readRDS(here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```

Load marine park shapefiles, and extract fishing status (e.g. 'Fished' or 'No-take') for use in modelling. The dataset used here is the 2022 Collaborative Australian Protected Areas Database, which is available for free download from https://fed.dcceew.gov.au/datasets/782c02c691014efe8ffbd27445fe41d7_0/explore. Feel free to replace this shapefile with any suitable dataset that is available for your study area. 

```{r parks}
marine.parks <- st_read(here::here("r-workflows/data/spatial/shapefiles/Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine.shp"))  %>%
  dplyr::select(geometry, ZONE_TYPE) %>%
  st_transform(4326) %>%
  st_make_valid()

metadata_sf <- st_as_sf(metadata, coords = c("longitude_dd", "latitude_dd"),
                      crs = 4326)

metadata <- metadata_sf %>%
  st_intersection(marine.parks) %>%
  bind_cols(st_coordinates(.)) %>%
  as.data.frame() %>%
  dplyr::select(-c(geometry)) %>%
  dplyr::rename(longitude_dd = X, latitude_dd = Y) %>%
  dplyr::mutate(status = if_else(str_detect(ZONE_TYPE, "National|Sanctuary"),
                                "No-take", "Fished")) %>%
  clean_names() %>%
  glimpse()
```

# Fish annotation data
There are two types of fish annotation data formats that you can check and format using this script: EventMeasure database outputs or “Generic” files. 

For EventMeasure data you will need to export the database outputs using EventMeasure and the .EMObs files. This will give you the _Points.txt, _Lengths.txt and _3DPoints.txt files.
“Generic” data is a much simpler format and allows users who haven’t used EventMeasure to format QC their annotation data. You will need a _Count.csv file and a _Length.csv file.

For more information on the format of these files please see the CheckEM user guide here:
https://globalarchivemanual.github.io/CheckEM/articles/manuals/CheckEM_user_guide.html

We recommend using the EventMeasure database exports if they are available and up to date. There are more checks possible with EventMeasure data than “Generic” data. 

If you have used EventMeasure software to annotate your samples BUT have made corrections on the exported data (e.g. in Excel), this corrected data is now the true copy of the data and you should import your data as “Generic” annotation files (e.g. count and length).

## Read in the fish annotation data
Load the count data (from _Points.txt files and from _Count.csv files).

### Load EventMeasure _Points.txt files
This section of code will read in any _Points.txt files that you have saved in the directory you set.
It will combine all of the files into one data-frame, and get the campaignid name from the name of the file.
Therefore, it is important that you consistently name your files with the same campaignid (look out for different separators e.g. '-', '_', or '.')

```{r load-points}
points <- CheckEM::read_points(here::here("r-workflows/data/raw/")) %>%
  glimpse()
```

### Load any Generic count files
This section of code will read in any _Count.csv files that you have saved in the directory you set.
It will combine all of the files into one dataframe, and get the campaignid name from the name of the file.
Therefore, it is important that you consistently name your files with the same campaignid (look out for different separators e.g. '-', '_', or '.')

```{r load-counts}
counts <- CheckEM::read_counts(here::here("r-workflows/data/raw/")) %>%
  glimpse()
```
## Combine EventMeasure and Generic count together
Create and tidy the MaxN file.

```{r create-maxn}

# Only run this if there is data in the counts data frame
if(nrow(points) > 1){
  maxn_points <- points %>% 
    dplyr::group_by(campaignid, sample, filename, periodtime, frame, family, genus, species) %>% # If you have MaxN'd by stage (e.g. Adult, Juvenile) add stage here
    dplyr::mutate(number = as.numeric(number)) %>%
    dplyr::summarise(maxn = sum(number)) %>%
    dplyr::group_by(campaignid, sample, family, genus, species) %>%
    dplyr::slice(which.max(maxn)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(!is.na(maxn)) %>%
    dplyr::select(-frame) %>%
    tidyr::replace_na(list(maxn = 0)) %>%
    dplyr::mutate(maxn = as.numeric(maxn)) %>%
    dplyr::filter(maxn > 0) %>%
    dplyr::inner_join(metadata) %>%
    dplyr::filter(successful_count %in% c("Yes")) %>% 
    dplyr::filter(maxn > 0) %>%
    glimpse()
}

# Only run this if there is data in the counts data frame
if(nrow(counts) > 1){
  maxn_counts <- counts %>%
    dplyr::group_by(campaignid, sample, family, genus, species) %>%
    dplyr::mutate(number = as.numeric(count)) %>%
    dplyr::summarise(maxn = sum(number)) %>%
    dplyr::group_by(campaignid, sample, family, genus, species) %>%
    dplyr::slice(which.max(maxn)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(!is.na(maxn)) %>%
    tidyr::replace_na(list(maxn = 0)) %>%
    dplyr::mutate(maxn = as.numeric(maxn)) %>%
    dplyr::filter(maxn > 0) %>%
    dplyr::inner_join(metadata) %>%
    dplyr::filter(successful_count %in% c("Yes")) %>%
    dplyr::filter(maxn > 0) %>%
    glimpse()
}

# If only EventMeasure data then MaxN only includes Points data
# If only Generic data then MaxN only includes Count data
# If both exist, then MaxN includes both Points and Count data
maxn <- bind_rows(get0("maxn_points"), get0("maxn_counts")) # this works even if you only have one type of data

```

Load the length data (from '_Lengths.txt' and '_3DPoints.txt').

```{r load-lengths}
length3dpoints <- read_files_length(here::here("r-workflows/data/raw/")) %>%                   
  dplyr::select(-c(comment))%>%
  dplyr::inner_join(metadata)%>%
  dplyr::filter(successful_length %in% "Yes") %>%
  glimpse() 
```

Tidy and complete MaxN data (e.g. complete zeroes in the data).

```{r tidy-maxn}
dat <- maxn %>%
  dplyr::select(campaignid, sample, family, genus, species, maxn) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  replace_na(list(maxn = 0)) %>%
  group_by(sample, family, genus, species) %>%
  dplyr::summarise(maxn = sum(maxn)) %>%
  ungroup() %>% 
  mutate(scientific = paste(family, genus, species, sep = " "))%>%
  dplyr::select(sample, scientific, maxn)%>%
  spread(scientific, maxn, fill = 0)

maxn.families <- maxn %>%
  dplyr::mutate(scientific = paste(family, genus, species, sep = " ")) %>%
  filter(!(family %in% "Unknown")) %>%
  dplyr::select(c(family, genus, species, scientific)) %>%
  distinct()

complete.maxn <- dat %>%
  pivot_longer(names_to = "scientific", values_to = "maxn",
               cols = 2:ncol(.)) %>%
  inner_join(maxn.families, by = c("scientific")) %>%
  full_join(metadata)%>%
  glimpse()
```

Tidy and complete length data (e.g. complete zeroes in the data).

```{r complete-length}
complete.length.number <- length3dpoints %>% 
  dplyr::filter(!family %in% "Unknown")%>%
  dplyr::right_join(metadata) %>%
  dplyr::filter(successful_length %in% "Yes") %>%
  dplyr::select(campaignid, sample, family, genus, species, length, number, range) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  dplyr::mutate(number = as.numeric(number)) %>%
  replace_na(list(number = 0)) %>%
  ungroup() %>%
  dplyr::filter(!is.na(number)) %>%
  dplyr::mutate(length = as.numeric(length)) %>%
  left_join(.,metadata) %>%
  tidyr::uncount(number) %>%
  glimpse()
```

# Save the checked data
Save MaxN as an R data file.

```{r save-maxn}
saveRDS(complete.maxn, 
          file = here::here(paste0("r-workflows/data/staging/",
                       name, "_complete-maxn.rds")))
```

Save lengths as an R data file.

```{r save-length}
saveRDS(complete.length.number, 
          file = here::here(paste0("r-workflows/data/staging/",
                       name, "_complete-length.rds")))
```
