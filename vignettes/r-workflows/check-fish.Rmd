---
title: "Checking fish data exported from EventMeasure"
author: "Claude Spencer & Brooke Gibbons"
date: "2023-11-13"
output:
  html_vignette:
    toc: true
    code_folding: hide
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Checking fish data exported from EventMeasure}
  %\VignetteEncoding{UTF-8}
---

This script documents the necessary steps to take raw data exported from EventMeasure, check for any errors in the annotation and format it into tidy data. You are required to also have a GlobalArchive format metadata file "*_Metadata.csv".

# R set up
Load the necessary libraries
```{r libraries, results='hide', warning=FALSE, message=FALSE}
library(devtools)
library(CheckEM)
library(tidyverse)
library(googlesheets4)
library(sf)
library(terra)
library(here)
```
Set the study name
```{r study-name}
name <- "example-bruv-workflow"
```
# Read in and format the metadata
Load and tidy the metadata. If you have already completed this step while checking your habitat data, then you can skip these next two chunks of code and simply read in the metadata (see below).
```{r load-metadata}
metadata <- read_metadata(here::here("r-workflows/data/raw/")) %>%
  dplyr::select(campaignid, sample, longitude_dd, latitude_dd, date_time, location, site, depth, successful_count, successful_length, successful_habitat_forward, successful_habitat_backward) %>%
  glimpse()
```
Save the metadata as an R data file (this creates a lighter file than saving as a .csv or similar)
```{r save-metadata}
saveRDS(metadata, file = here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```
Load metadata if you have already exported in the 'check-habitat' scripts. If you have just loaded and saved the metadata, then you can skip this chunk of code.
```{r tidy-metadata}
metadata <- readRDS(here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```
Load marine park shapefiles, and extract fishing status (e.g. 'Fished' or 'No-take') for use in modelling
```{r parks}
marine.parks <- st_read(here::here("r-workflows/data/spatial/shapefiles/Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine.shp"))  %>%
  dplyr::select(geometry, ZONE_TYPE) %>%
  st_transform(4326) %>%
  st_make_valid()

metadata_sf <- st_as_sf(metadata, coords = c("longitude_dd", "latitude_dd"),
                      crs = 4326)

metadata <- metadata_sf %>%
  st_intersection(marine.parks) %>%
  bind_cols(st_coordinates(.)) %>%
  as.data.frame() %>%
  dplyr::select(-c(geometry)) %>%
  dplyr::rename(longitude_dd = X, latitude_dd = Y) %>%
  dplyr::mutate(status = if_else(str_detect(ZONE_TYPE, "National|Sanctuary"),
                                "No-take", "Fished")) %>%
  clean_names() %>%
  glimpse()
```
# Read in the raw data
Load the count data (MaxN from _Points.txt file)
```{r load-points}
points <- CheckEM::read_files_maxn(here::here("r-workflows/data/raw/")) %>%
  glimpse()
```
Create and tidy the MaxN file
```{r create-maxn}
maxn <- points %>% 
  dplyr::group_by(campaignid, sample, filename, periodtime, frame, family, genus, species) %>% 
  dplyr::mutate(number = as.numeric(number)) %>%
  dplyr::summarise(maxn = sum(number)) %>%
  dplyr::group_by(campaignid, sample, family, genus, species) %>%
  dplyr::slice(which.max(maxn)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(maxn)) %>%
  dplyr::select(-frame) %>%
  tidyr::replace_na(list(maxn = 0)) %>%
  dplyr::mutate(maxn = as.numeric(maxn)) %>%
  dplyr::filter(maxn > 0) %>%
  dplyr::inner_join(metadata) %>%
  dplyr::filter(successful_count %in% c("Yes")) %>% 
  dplyr::filter(maxn > 0) %>%
  glimpse()
```
Load the length data (from '_Lengths.txt' and '_3DPoints.txt')
```{r load-lengths}
length3dpoints <- read_files_length(here::here("r-workflows/data/raw/")) %>%                   
  dplyr::select(-c(comment))%>%
  dplyr::inner_join(metadata)%>%
  dplyr::filter(successful_length %in% "Yes") %>%
  glimpse() 
```
Tidy and complete MaxN data (e.g. complete zeroes in the data)
```{r tidy-maxn}
dat <- maxn %>%
  dplyr::select(campaignid, sample, family, genus, species, maxn) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  replace_na(list(maxn = 0)) %>%
  group_by(sample, family, genus, species) %>%
  dplyr::summarise(maxn = sum(maxn)) %>%
  ungroup() %>% 
  mutate(scientific = paste(family, genus, species, sep = " "))%>%
  dplyr::select(sample, scientific, maxn)%>%
  spread(scientific, maxn, fill = 0)%>%
  glimpse()

maxn.families <- maxn %>%
  dplyr::mutate(scientific = paste(family, genus, species, sep = " ")) %>%
  filter(!(family %in% "Unknown")) %>%
  dplyr::select(c(family, genus, species, scientific)) %>%
  distinct() %>%
  glimpse()

complete.maxn <- dat %>%
  pivot_longer(names_to = "scientific", values_to = "maxn",
               cols = 2:ncol(.)) %>%
  inner_join(maxn.families, by = c("scientific")) %>%
  full_join(metadata)%>%
  glimpse()
```
Tidy and complete length data (e.g. complete zeroes in the data)
```{r complete-length}
complete.length.number <- length3dpoints %>% 
  dplyr::filter(!family %in% "Unknown")%>%
  dplyr::right_join(metadata) %>%
  dplyr::filter(successful_length %in% "Yes") %>%
  dplyr::select(campaignid, sample, family, genus, species, length, number, range) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  dplyr::mutate(number = as.numeric(number)) %>%
  replace_na(list(number = 0)) %>%
  ungroup() %>%
  dplyr::filter(!is.na(number)) %>%
  dplyr::mutate(length = as.numeric(length)) %>%
  left_join(.,metadata) %>%
  tidyr::uncount(number) %>%
  glimpse()
```
# Save the checked data
Save MaxN as an R data file
```{r save-maxn}
saveRDS(complete.maxn, 
          file = here::here(paste0("r-workflows/data/staging/",
                       name, "_complete-maxn.rds")))
```
Save lengths as an R data file
```{r save-length}
saveRDS(complete.length.number, 
          file = here::here(paste0("r-workflows/data/staging/",
                       name, "_complete-length.rds")))
```
