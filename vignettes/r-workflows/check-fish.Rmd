---
title: "Checking fish data exported from EventMeasure"
author: "Claude Spencer & Brooke Gibbons"
date: "2023-11-13"
output:
  html_vignette:
    toc: true
    code_folding: hide
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Checking fish data exported from EventMeasure}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
# knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_knit$set(root.dir = "..")
```

```{r working-dir}
# getwd()
```

```{r libraries, results='hide', warning=FALSE, message=FALSE}
# Load Libraries ----
library(devtools)
library(CheckEM)
library(tidyverse)
library(googlesheets4)
library(sf)
library(terra)
```

```{r name}
name <- "example-bruv-workflow"
```

```{r metadata}
metadata <- read_metadata(here::here("r-workflows/data/raw/")) %>%
  dplyr::select(campaignid, sample, longitude_dd, latitude_dd, date_time, location,  # Review columns to align with GlobalArchive - plus make metadata match
                site, depth, successful_count, successful_length,
                successful_habitat_forward, successful_habitat_backward) %>%
  glimpse()

saveRDS(metadata, file = here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```

```{r metadata-rds}
metadata <- readRDS(here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```

```{r marine-parks}
# marine.parks <- st_read("r-workflows/data/spatial/shapefiles/")  %>% 
#   dplyr::select(geometry, ZoneName) %>%
#   st_transform(4326) %>%
#   st_make_valid()
# 
# metadata_sf <- st_as_sf(metadata, coords = c("longitude_dd", "latitude_dd"), 
#                       crs = 4326)
# 
# metadata <- metadata_sf %>%
#   st_intersection(marine.parks) %>%
#   bind_cols(st_coordinates(.)) %>%
#   as.data.frame() %>%
#   dplyr::select(-c(geometry)) %>%
#   dplyr::rename(longitude_dd = X, latitude_dd = Y) %>%
#   dplyr::mutate(status = if_else(str_detect(ZoneName, "National|Sanctuary"), 
#                                 "No-take", "Fished")) %>%
#   clean_names() %>%
#   glimpse()
```


# 2. Extract fishing status ----
# Use this section if you need to work out which samples are inside areas closed to fishing
# TODO change to CAPAD file


# 3. Load MaxN data ----
points <- list.files(path = "r-workflows/data/raw/",      # This replaces ga.list.files
                     recursive = T,
                     pattern = "_Points.txt",
                     full.names = T) %>% # list all files ending in "_Points.txt"
  purrr::map(~CheckEM::read_files_txt(.)) %>% # This function reads in all text files identified above, combines them into one dataframe, and creates the campaignid column from the filename
  purrr::list_rbind() %>%
  glimpse()

maxn <- points %>% 
  dplyr::group_by(campaignid, sample, filename, periodtime, frame, family, genus, species) %>% # Add stage here if you would like to create MaxN by stage
  dplyr::mutate(number = as.numeric(number)) %>%
  dplyr::summarise(maxn = sum(number)) %>%
  dplyr::group_by(campaignid, sample, family, genus, species) %>%
  dplyr::slice(which.max(maxn)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(maxn)) %>%
  dplyr::select(-frame) %>%
  tidyr::replace_na(list(maxn = 0)) %>%
  dplyr::mutate(maxn = as.numeric(maxn)) %>%
  dplyr::filter(maxn > 0) %>%
  dplyr::inner_join(metadata) %>%
  dplyr::filter(successful_count %in% c("Yes")) %>% # Remove any samples that were not marked in the metadata as successful for count
  dplyr::filter(maxn > 0) %>%
  glimpse()

# 4. Load length & 3D point data ----
length3dpoints <- list.files(path = "r-workflows/data/raw/",
                             recursive = T,
                             pattern = "_3DPoints.txt|_Lengths.txt",
                             full.names = T) %>%
  purrr::map(~CheckEM::read_files_txt(.)) %>%
  purrr::list_rbind() %>%
  dplyr::select(-c(comment))%>% # take comment out as there is also a comment column in the metadata
  dplyr::inner_join(metadata)%>%
  dplyr::filter(successful_length %in% "Yes") %>% # Remove any samples that were not marked in the metadata as successful for length measurements
  glimpse()

# 5. Complete and tidy datasets, run data checks
dat <- maxn %>%
  dplyr::select(campaignid, sample, family, genus, species, maxn) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  replace_na(list(maxn = 0)) %>%
  group_by(sample, family, genus, species) %>%
  dplyr::summarise(maxn = sum(maxn)) %>%
  ungroup() %>% 
  mutate(scientific = paste(family, genus, species, sep = " "))%>%
  dplyr::select(sample, scientific, maxn)%>%
  spread(scientific, maxn, fill = 0)%>%
  glimpse()

maxn.families <- maxn %>%
  dplyr::mutate(scientific = paste(family, genus, species, sep = " ")) %>%
  filter(!(family %in% "Unknown")) %>%
  dplyr::select(c(family, genus, species, scientific)) %>%
  distinct() %>%
  glimpse()

complete.maxn <- dat %>%
  pivot_longer(names_to = "scientific", values_to = "maxn",
               cols = 2:ncol(.)) %>%
  inner_join(maxn.families, by = c("scientific")) %>%
  full_join(metadata)%>%
  glimpse()

length.families <- length3dpoints %>%
  dplyr::filter(!(family %in% "Unknown")) %>%
  dplyr::select(family, genus, species)%>%
  distinct() %>%
  glimpse()

complete.length.number <- length3dpoints %>% 
  dplyr::filter(!family %in% "Unknown")%>%
  dplyr::right_join(metadata) %>%
  dplyr::filter(successful_length %in% "Yes") %>%
  dplyr::select(campaignid, sample, family, genus, species, length, number, range) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  dplyr::mutate(number = as.numeric(number)) %>%
  replace_na(list(number = 0)) %>% # We add in zeros - in case we want to calculate abundance of species based on a length rule (e.g. greater than legal size)
  ungroup() %>%
  dplyr::filter(!is.na(number)) %>% # this should not do anything
  dplyr::mutate(length = as.numeric(length)) %>%
  left_join(.,metadata) %>%
  tidyr::uncount(number) %>%
  glimpse()

# 6. Save datasets ----
saveRDS(complete.maxn, 
          file = paste0("r-workflows/data/staging/",
                       name, "_Complete-maxn.rds"))

saveRDS(complete.length.number, 
          file = paste0("r-workflows/data/staging/",
                       name, "_Complete-length.rds"))