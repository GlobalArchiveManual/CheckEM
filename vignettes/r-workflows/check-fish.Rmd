---
title: "Checking fish data exported from EventMeasure"
author: "Claude Spencer & Brooke Gibbons"
date: "2024-01-19"
output:
  html_vignette:
    toc: true
    code_folding: hide
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Checking fish data exported from EventMeasure}
  %\VignetteEncoding{UTF-8}
---

```{TODO list eval=FALSE, include=FALSE}
# TODO
# Add a error report
# Turn every check into a function
# In the function, if the user says "Yes" or TRUE to error_report add the check to the error report
# 


```

This script will take raw fish data (either exported from EventMeasure or "Generic" format, see format requirements [here](https://globalarchivemanual.github.io/CheckEM/articles/manuals/CheckEM_user_guide.html)) and check for any errors in the annotation.
The script will then format the annotation data into a tidy format.

You will require to also have a formatted sample metadata file "*_Metadata.csv" (see format requirements [here](https://globalarchivemanual.github.io/CheckEM/articles/manuals/CheckEM_user_guide.html))

# R set up
First you will need to load the necessary libraries.
If you haven't installed CheckEM before you will need to install CheckEM using the install_github function.

```{r libraries, message=FALSE, warning=FALSE, results='hide'}
library(devtools)
# devtools::install_github("GlobalArchiveManual/CheckEM") # Use this to install the CheckEM package if you have not already done so
library(CheckEM)
library(tidyverse)
library(googlesheets4)
library(sf)
library(terra)
library(here)
library(rgeos)
```

Next set the study name.
This can be any name you like, all files saved using this script will be prefixed with this name.

```{r study-name}
name <- "example-bruv-workflow"
```

# Metadata
Now we load and tidy the metadata. 
If you have already completed this step while checking your habitat data, then you can skip these next two chunks of code and simply read in the metadata (see below).

```{r load-metadata}
metadata <- read_metadata(here::here("r-workflows/data/raw/")) %>%
  dplyr::select(campaignid, sample, longitude_dd, latitude_dd, date_time, location, site, depth, successful_count, successful_length, successful_habitat_forward, successful_habitat_backward) %>%
  glimpse()
```

Save the metadata as an R data file (this creates a lighter file than saving as a .csv or similar, it also maintains any column formatting).

```{r save-metadata}
saveRDS(metadata, file = here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```

If you have already exported in the 'check-habitat' script then load the metadata.
If you have just loaded and saved the metadata, then you can skip this chunk of code.

```{r tidy-metadata}
metadata <- readRDS(here::here(paste0("r-workflows/data/tidy/",
                                name, "_Metadata.rds")))
```

# Marine Parks
Load marine park shape files, and extract fishing status (e.g. 'Fished' or 'No-take') for use in modelling. 
The data set used here is the 2022 Collaborative Australian Protected Areas Database, which you can download for free [here](https://fed.dcceew.gov.au/datasets/782c02c691014efe8ffbd27445fe41d7_0/explore).

You may change this shape file to any suitable data set that is available for your study area. 

```{r parks}
marine_parks <- st_read(here::here("r-workflows/data/spatial/shapefiles/Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine.shp"))  %>%
  dplyr::select(geometry, ZONE_TYPE) %>%
  st_transform(4326) %>%
  st_make_valid()

metadata_sf <- st_as_sf(metadata, coords = c("longitude_dd", "latitude_dd"),
                      crs = 4326)

metadata <- metadata_sf %>%
  st_intersection(marine_parks) %>%
  bind_cols(st_coordinates(.)) %>%
  as.data.frame() %>%
  dplyr::select(-c(geometry)) %>%
  dplyr::rename(longitude_dd = X, latitude_dd = Y) %>%
  dplyr::mutate(status = if_else(str_detect(ZONE_TYPE, "National|Sanctuary"),
                                "No-take", "Fished")) %>%
  clean_names() %>%
  glimpse()
```
# Find nearest Marine Region
We need to find the nearest marine region for each sample. Then we can use the life history lists to find species that have not been observed in that marine region before.

```{r marine region, warning=FALSE}
temp_metadata <- metadata

coordinates(temp_metadata) <- c('longitude_dd', 'latitude_dd')
proj4string(temp_metadata) <- CRS("+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0")
n <- nrow(temp_metadata)
nearest.region <- character(n)

## For each point, find name of nearest polygon
for (i in seq_along(nearest.region)) {
  nearest.region[i] <- CheckEM::aus_regions$REGION[which.min(gDistance(temp_metadata[i, ], CheckEM::aus_regions, byid = TRUE))]
  }

## Check that it worked
metadata <- as.data.frame(nearest.region) %>%
  bind_cols(metadata,.) %>%
  dplyr::rename(marine_region = nearest.region) %>%
  dplyr::mutate(sample = as.character(sample)) %>%
  glimpse()
```

# Fish annotation data
There are two types of fish annotation data formats that you can check and format using this script: EventMeasure database outputs or “Generic” files. 

For EventMeasure data you will need to export the database outputs using EventMeasure and the .EMObs files. This will give you the '_Points.txt', '_Lengths.txt' and '_3DPoints.txt' files.
“Generic” data is a much simpler format and allows users who haven’t used EventMeasure to format QC their annotation data. You will need a _Count.csv file and a _Length.csv file.

For more information on the format of these files please see the [CheckEM user guide](https://globalarchivemanual.github.io/CheckEM/articles/manuals/CheckEM_user_guide.html)

We recommend using the EventMeasure database exports if they are available and up to date. There are more checks possible with EventMeasure data than “Generic” data. 
**Note:** If you have used EventMeasure software to annotate your samples BUT have made corrections on the exported data (e.g. in Excel), this corrected data is now the true copy of the data and you should import your data as “Generic” annotation files (e.g. count and length).

## Load any EventMeasure _Points.txt files
This section of code will read in any 'Points.txt' files that you have saved in the directory you set.
It will combine all of the files into one data-frame, and get the campaignid name from the name of the file.
It is important that you consistently name your files with the same campaignid (look out for different separators e.g. '-', '_', or '.')

```{r load-points}
points <- read_points(here::here("r-workflows/data/raw/")) %>%
  glimpse()
```

## Load any "Generic" count files
This section of code will read in any 'Count.csv' files that you have saved in the directory you set.
It will combine all of the files into one data frame, and get the campaignid name from the name of the file.

It is important that you consistently name your files with the same campaignid (look out for different separators e.g. '-', '_', or '.')

```{r load-counts}
counts <- read_counts(here::here("r-workflows/data/raw/")) %>%
  glimpse()
```
## Combine EventMeasure and "Generic" count together
Create and tidy the MaxN file.

```{r create-maxn}

# Only run this if there is data in the counts data frame
if(nrow(points) > 1){
  maxn_points <- points %>% 
    dplyr::group_by(campaignid, sample, filename, periodtime, frame, family, genus, species) %>% # If you have MaxN'd by stage (e.g. Adult, Juvenile) add stage here
    dplyr::mutate(number = as.numeric(number)) %>%
    dplyr::summarise(maxn = sum(number)) %>%
    dplyr::ungroup() %>%
    dplyr::group_by(campaignid, sample, family, genus, species) %>%
    dplyr::slice(which.max(maxn)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(!is.na(maxn)) %>%
    dplyr::select(-frame) %>%
    tidyr::replace_na(list(maxn = 0)) %>%
    dplyr::mutate(maxn = as.numeric(maxn)) %>%
    dplyr::filter(maxn > 0) %>%
    dplyr::inner_join(metadata, by = join_by(campaignid, sample)) %>%
    dplyr::filter(successful_count %in% c("Yes")) %>% 
    dplyr::filter(maxn > 0) %>%
    dplyr::select(campaignid, sample, family, genus, species, maxn) %>%
    glimpse()
}

# Only run this if there is data in the counts data frame
if(nrow(counts) > 1){
  maxn_counts <- counts %>%
    dplyr::group_by(campaignid, sample, family, genus, species) %>%
    dplyr::mutate(number = as.numeric(count)) %>%
    dplyr::summarise(maxn = sum(number)) %>%
    dplyr::group_by(campaignid, sample, family, genus, species) %>%
    dplyr::slice(which.max(maxn)) %>%
    dplyr::ungroup() %>%
    dplyr::filter(!is.na(maxn)) %>%
    tidyr::replace_na(list(maxn = 0)) %>%
    dplyr::mutate(maxn = as.numeric(maxn)) %>%
    dplyr::filter(maxn > 0) %>%
    dplyr::inner_join(metadata, by = join_by(campaignid, sample)) %>%
    dplyr::filter(successful_count %in% c("Yes")) %>%
    dplyr::filter(maxn > 0) %>%
    dplyr::select(campaignid, sample, family, genus, species, maxn) %>%
    glimpse()
}

# If only EventMeasure data then MaxN only includes Points data
# If only Generic data then MaxN only includes Count data
# If both exist, then MaxN includes both Points and Count data
maxn <- bind_rows(get0("maxn_points"), get0("maxn_counts")) # this works even if you only have one type of data
```

## Load any EventMeasure '_Lengths.txt' and/or '_3DPoints.txt' files
This section of code will read in any '_Lengths.txt' and/or '_3DPoints.txt' files that you have saved in the directory you set.
It will combine all of the files into one data-frame, and get the campaignid name from the name of the file.
It is important that you consistently name your files with the same campaignid (look out for different separators e.g. '-', '_', or '.')

```{r load-lengths}
em_length3dpoints <- read_em_length(here::here("r-workflows/data/raw/")) %>%                   
  dplyr::select(-c(comment))%>% # there is a comment column in metadata, so you will need to remove this column from EM data
  dplyr::inner_join(metadata, by = join_by(sample, campaignid)) %>%
  dplyr::filter(successful_length %in% "Yes") %>%
  dplyr::rename(length_mm = length) %>%
  glimpse() 
```

## Load any "Generic" length files
This section of code will read in any _Length.csv files that you have saved in the directory you set.
It will combine all of the files into one data frame, and get the campaignid name from the name of the file.
It is important that you consistently name your files with the same campaignid (look out for different separators e.g. '-', '_', or '.')

```{r load-gen-lengths}
gen_length <- read_gen_length(here::here("r-workflows/data/raw/")) %>%                   
  dplyr::full_join(metadata, by = join_by(campaignid, sample)) %>%
  dplyr::filter(successful_length %in% "Yes") %>%
  glimpse() 
```

## Combine EventMeasure and "Generic" length data
```{r combine-length}
# If only EventMeasure data then length only includes Length and 3D points data
# If only Generic data then length only includes generic length data
# If both exist, then length includes both Length and 3D points and generic length data
length <- bind_rows(get0("em_length3dpoints"), get0("gen_length")) # this works even if you only have one type of data
```

# Format and add zeros where a species isn't present
## In the count data
Tidy and "complete" MaxN data (e.g. add zeros in the data where a species wasn't observed).
The final data set will have a row for each species in every sample (deployment).

```{r tidy-maxn}
count <- maxn %>%
  dplyr::mutate(family = ifelse(family %in% c("NA", "NANA", NA, "unknown", "", NULL, " ", NA_character_), "Unknown", as.character(family))) %>%
  dplyr::mutate(genus = ifelse(genus %in% c("NA", "NANA", NA, "unknown", "", NULL, " ", NA_character_), "Unknown", as.character(genus))) %>%
  dplyr::mutate(species = ifelse(species %in% c("NA", "NANA", NA, "unknown", "", NULL, " ", NA_character_), "spp", as.character(species))) %>%
  dplyr::select(campaignid, sample, family, genus, species, maxn) %>%
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  tidyr::replace_na(list(maxn = 0)) %>%
  group_by(campaignid, sample, family, genus, species) %>%
  dplyr::summarise(count = sum(maxn)) %>%
  ungroup() %>%
  mutate(scientific = paste(family, genus, species, sep = " "))%>%
  dplyr::select(campaignid, sample, scientific, count)%>%
  spread(scientific, count, fill = 0)

count_families <- maxn %>%
  dplyr::mutate(scientific = paste(family, genus, species, sep = " ")) %>%
  filter(!(family %in% "Unknown")) %>%
  dplyr::select(c(family, genus, species, scientific)) %>%
  distinct()

complete_count <- count %>%
  pivot_longer(names_to = "scientific", values_to = "count",
               cols = 3:ncol(.)) %>%
  inner_join(count_families, by = c("scientific")) %>%
  full_join(metadata)%>%
  glimpse()
```

## In the length data
Tidy and complete length data (e.g. complete zeroes in the data).

```{r complete-length}
complete_length <- length %>%
  dplyr::mutate(family = ifelse(family %in% c("NA", "NANA", NA, "unknown", "", NULL, " ", NA_character_), "Unknown", as.character(family))) %>%
  dplyr::mutate(genus = ifelse(genus %in% c("NA", "NANA", NA, "unknown", "", NULL, " ", NA_character_), "Unknown", as.character(genus))) %>%
  dplyr::mutate(species = ifelse(species %in% c("NA", "NANA", NA, "unknown", "", NULL, " ", NA_character_), "spp", as.character(species))) %>%
  dplyr::filter(!family %in% "Unknown")%>%
  dplyr::right_join(metadata) %>%
  dplyr::filter(successful_length %in% "Yes") %>%
  dplyr::select(campaignid, sample, family, genus, species, length_mm, number, any_of(c("range", "rms", "precision"))) %>% # this will keep EM only columns
  tidyr::complete(nesting(campaignid, sample), nesting(family, genus, species)) %>%
  dplyr::mutate(number = as.numeric(number)) %>%
  replace_na(list(number = 0)) %>%
  ungroup() %>%
  dplyr::filter(!is.na(number)) %>%
  dplyr::mutate(length_mm = as.numeric(length_mm)) %>%
  left_join(., metadata) %>%
  tidyr::uncount(number) %>%
  dplyr::mutate(count = 1) %>%
  glimpse()
```
# Quality Control Checks
Now we have some-what tidy data we can begin to run some checks.

## Number of unique samples in the metadata
This is the total number of unique samples in the sample metadata (it should also be the number of rows in the metadata data frame)

```{r number-metadata-samples}
number_of_samples <- metadata %>%
  dplyr::distinct(campaignid, sample)

message(paste(nrow(number_of_samples), "unique samples in the metadata"))
```
## Check for duplicate sample names
If you have any duplicate samples within a campaign they will be displayed here
```{r duplicate-metadata-samples}
duplicate_samples <- metadata %>%
  dplyr::group_by(campaignid, sample) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(n > 1)

message(paste(nrow(duplicate_samples), "samples duplicated in the metadata"))
```

## Number of sample(s) without points or count data
This could be due to samples not observing fish (not an error) or a sample that should be marked as successful_count = No. 
It could also be due to a sample name spelt incorrectly in the count/points or sample metadata file.

```{r samples-missing-count}
metadata_samples <- metadata %>%
  dplyr::select(campaignid, sample, dplyr::any_of(c("opcode", "period")), 
                successful_count, successful_length) %>%
  distinct()

samples <- maxn %>%
  distinct(campaignid, sample)

missing_count <- anti_join(metadata_samples, samples, by = join_by(campaignid, sample))

message(paste(nrow(missing_count), "samples in the metadata missing count data"))
```

## Samples in the count data missing metadata
```{r count-missing-metadata}
missing_metadata <- anti_join(samples, metadata_samples, by = join_by(campaignid, sample))
message(paste(nrow(missing_metadata), "samples in count data missing metadata"))
```

## Number of sample(s) without length or 3D point data
This could be due to samples not observing fish (not an error) or a sample that should be marked as successful_length = No. 
It could also be due to a sample name spelt incorrectly in the EMObs or Length file or the sample metadata file.

```{r samples-missing-length}
metadata_samples <- metadata %>%
  dplyr::select(campaignid, sample, dplyr::any_of(c("opcode", "period")), 
                successful_count, successful_length) %>%
  distinct()

samples <- length %>%
  distinct(campaignid, sample)

missing_length <- anti_join(metadata_samples, samples, by = join_by(campaignid, sample))

message(paste(nrow(missing_length), "samples in metadata missing length data"))
```

## Samples in the length data missing metadata
```{r length-missing-metadata}
missing_metadata <- anti_join(samples, metadata_samples, by = join_by(campaignid, sample))

message(paste(nrow(missing_metadata), "samples in length data missing metadata"))
```

## Periods without an end (EM only)
This check is only important if you have used periods to define your sampling duration.

```{r load-periods}
periods <- read_periods(here::here("r-workflows/data/raw/")) %>%
  glimpse()

periods_without_end <- periods %>%
  dplyr::filter(has_end == 0)

message(paste(nrow(periods_without_end), "periods without an end"))
glimpse(periods_without_end)
```

## Samples without periods (EM only)
This check is only important if you have used periods to define your sampling duration.

```{r missing-periods}
metadata_samples <- metadata %>%
  dplyr::select(campaignid, sample, dplyr::any_of(c("opcode", "period")), successful_count, successful_length) %>%
  dplyr::distinct() %>%
  dplyr::mutate(sample = as.factor(sample))

periods_samples <- periods %>%
  dplyr::select(campaignid, sample, dplyr::any_of(c("opcode", "period"))) %>%
  distinct()

missing_periods <- anti_join(metadata_samples, periods_samples) %>%
  dplyr::select(!sample)

message(paste(nrow(missing_periods), "samples missing period"))
glimpse(missing_periods)
```

## Points outside Periods (EM only)
```{r points-outside-periods}
points_outside_periods <- points %>%
  dplyr::filter(period %in% c("NA", NA, NULL, "")) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species, number, frame)

message(paste(nrow(points_outside_periods), "points outside a period"))
glimpse(points_outside_periods)
```

## Length measurement(s) or 3D point(s) outside periods (EM only)
```{r lengths-outside-periods}
lengths_outside_periods <- em_length3dpoints %>%
  dplyr::filter(period %in% c("NA", NA, NULL, "")) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species, number)

message(paste(nrow(lengths_outside_periods), "lengths/3D points outside period"))
glimpse(lengths_outside_periods)
```

## Period(s) that are not the correct duration (EM only)
```{r periods-wrong-length}
period_length <- 60 # in minutes

periods_wrong <- periods %>%
        dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), time_start, time_end, has_end) %>%
        dplyr::distinct() %>%
        dplyr::mutate(period_time = round(time_end - time_start)) %>%
        dplyr::filter(!period_time %in% period_length)

message(paste(nrow(periods_wrong), "periods not", period_length, "minutes long"))
glimpse(periods_wrong)
```

## Total number of individuals observed
This is the total number of individuals observed in the count data:
```{r total-in-maxn}
total_count <- sum(complete_count$count)
message(paste(total_count, "fish counted in the count data"))
```
This is the total number of individuals observed in the length data:
```{r total-in-lengths}
total_length <- sum(complete_length$count)
message(paste(total_length, "fish counted in the length data"))
```

## Points without a number (EM only)
This is a check for EventMeasure data.

```{r points-without-a-number}
# TODO add some more comments about why these are important to fix
points_without_number <- points %>%
  filter(number %in% c("NA", NA, 0, NULL, "", " "))

message(paste(nrow(points_without_number), "points in the _Points.txt file that do not have a number"))
glimpse(points_without_number)
```

## Length measurements without a number (EM only)
```{r lengths-without-a-number}
# TODO add some more comments about why these are important to fix
points_without_number <- points %>%
  filter(number %in% c("NA", NA, 0, NULL, "", " "))

message(paste(nrow(points_without_number), "points in the _Points.txt file that do not have a number"))
glimpse(points_without_number)
```

## Species names that have been updated (Count)
```{r count-synonyms}
synonyms_in_count <- dplyr::left_join(complete_count, CheckEM::aus_synonyms) %>%
      dplyr::filter(!is.na(genus_correct)) %>%
      dplyr::mutate('old name' = paste(family, genus, species, sep = " ")) %>%
      dplyr::mutate('new name' = paste(family_correct, genus_correct, species_correct, sep = " ")) %>%
      dplyr::select('old name', 'new name') %>%
      dplyr::distinct()

message(paste(nrow(synonyms_in_count), "synonyms used in the count data"))
glimpse(synonyms_in_count)
```

## Species names that have been updated (Length)
```{r length-synonyms}
synonyms_in_length <- dplyr::left_join(complete_length, CheckEM::aus_synonyms) %>%
      dplyr::filter(!is.na(genus_correct)) %>%
      dplyr::mutate('old name' = paste(family, genus, species, sep = " ")) %>%
      dplyr::mutate('new name' = paste(family_correct, genus_correct, species_correct, sep = " ")) %>%
      dplyr::select('old name', 'new name') %>%
      dplyr::distinct()

message(paste(nrow(synonyms_in_length), "synonyms used in the length data"))
glimpse(synonyms_in_length)
```
# Change synonyms names here
add warning about skipping this section if wanted

```{r change-count-synonyms}
complete_count <- dplyr::left_join(complete_count, CheckEM::aus_synonyms) %>%
  dplyr::mutate(genus = ifelse(!genus_correct%in%c(NA), genus_correct, genus)) %>%
  dplyr::mutate(species = ifelse(!is.na(species_correct), species_correct, species)) %>%
  dplyr::mutate(family = ifelse(!is.na(family_correct), family_correct, family)) %>%
  dplyr::select(-c(family_correct, genus_correct, species_correct)) %>%
  dplyr::mutate(scientific = paste(family, genus, species))
```

```{r change-length-synonyms}
complete_length <- dplyr::left_join(complete_length, CheckEM::aus_synonyms) %>%
  dplyr::mutate(genus = ifelse(!genus_correct%in%c(NA), genus_correct, genus)) %>%
  dplyr::mutate(species = ifelse(!is.na(species_correct), species_correct, species)) %>%
  dplyr::mutate(family = ifelse(!is.na(family_correct), family_correct, family)) %>%
  dplyr::select(-c(family_correct, genus_correct, species_correct)) %>%
  dplyr::mutate(scientific = paste(family, genus, species))
```
## Species not observed in the area before (Count)
```{r count-species-not-in-area}
count_species_not_observed_region <- complete_count %>%
  dplyr::distinct(campaignid, sample, family, genus, species, marine_region, count) %>%
  dplyr::anti_join(., expand_life_history(CheckEM::australia_life_history), by = c("family", "genus", "species", "marine_region")) %>%
  dplyr::filter(count > 0) %>%
  dplyr::left_join(metadata) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species, marine_region) %>%
  dplyr::distinct() %>%
  dplyr::rename('marine region not observed in' = marine_region) %>%
  dplyr::semi_join(., CheckEM::australia_life_history, by = c("family", "genus", "species"))

message(paste(nrow(count_species_not_observed_region), "species not observed in the region before"))
glimpse(count_species_not_observed_region)
```

## Species not observed in the area before (Length)
```{r length-species-not-in-area}
length_species_not_observed_region <- complete_length %>%
  dplyr::distinct(campaignid, sample, family, genus, species, marine_region, count) %>%
  dplyr::anti_join(., expand_life_history(CheckEM::australia_life_history), by = c("family", "genus", "species", "marine_region")) %>%
  dplyr::filter(count > 0) %>%
  dplyr::left_join(metadata) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species, marine_region) %>%
  dplyr::distinct() %>%
  dplyr::rename('marine region not observed in' = marine_region) %>%
  dplyr::semi_join(., CheckEM::australia_life_history, by = c("family", "genus", "species"))

message(paste(nrow(length_species_not_observed_region), "species not observed in the region before"))
glimpse(length_species_not_observed_region)
```

## Species not listed in the life history list (Count)
If you chose to update the names that have changed (synonyms) then these check won't include those names.

```{r count-species-not-in-list}
count_species_not_in_list <- complete_count %>%
  dplyr::anti_join(., CheckEM::australia_life_history, by = c("family", "genus", "species")) %>%
  dplyr::filter(count > 0) %>%
  dplyr::left_join(metadata) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species) %>%
  dplyr::distinct() 

message(paste(nrow(count_species_not_in_list), "species not in chosen life history list"))
glimpse(count_species_not_in_list)
```

## Species not listed in the life history list (Length)
```{r length-species-not-in-list}
length_species_not_in_list <- complete_length %>%
  dplyr::anti_join(., CheckEM::australia_life_history, by = c("family", "genus", "species")) %>%
  dplyr::filter(count > 0) %>%
  dplyr::left_join(metadata) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species) %>%
  dplyr::distinct() 

message(paste(nrow(length_species_not_in_list), "species not in chosen life history list"))
glimpse(length_species_not_in_list)
```

## Length measurements smaller or bigger than the fishbase minimum and maximums

```{r incorrect-lengths}
incorrect_lengths <- left_join(complete_length, create_min_max(CheckEM::australia_life_history, minimum = 0.15, maximum = 0.85)) %>%
  dplyr::filter(length_mm < min_length_mm | length_mm > max_length_mm) %>%
  mutate(reason = ifelse(length_mm < min_length_mm, "too small", "too big")) %>%
  dplyr::select(campaignid, sample, family, genus, species, length_mm, min_length_mm, max_length_mm, fb_length_max, reason, any_of(c("em_comment", "frame_left")), fb_length_max) %>%
  mutate(difference = ifelse(reason %in% c("too small"), (min_length_mm - length_mm), (length_mm - max_length_mm))) %>%
  dplyr::mutate(percent_of_fb_max = (length_mm/fb_length_max)*100) %>%
  dplyr::left_join(metadata) %>%
  dplyr::select(campaignid, dplyr::any_of(c("opcode", "period")), family, genus, species, length_mm, min_length_mm, max_length_mm, fb_length_max, reason, any_of(c("em_comment", "frame_left")), difference, percent_of_fb_max)

too_small <- incorrect_lengths %>%
  dplyr::filter(reason %in% "too small")

too_big <- incorrect_lengths %>%
  dplyr::filter(reason %in% "too big")

message(paste(nrow(too_small), "lengths are too small"))
glimpse(too_small)

message(paste(nrow(too_big), "lengths are too big"))
glimpse(too_big)
```
## Number of 3D points and length measurements over the RMS limit (EM only)


```{r length-over-rms}
rms_limit <- 20 # in mm

over_rms <- complete_length %>%
  dplyr::filter(as.numeric(rms) > rms_limit)

message(paste(nrow(over_rms), "lengths over RMS limit"))
glimpse(over_rms)
```
## Number of length measurements over the precision limit (EM only)


```{r length-over-precision}
precision_limit <- 10 # in %

over_precision <- complete_length %>%
  dplyr::filter(as.numeric(precision) > precision_limit)

message(paste(nrow(over_precision), "lengths over precision limit"))
glimpse(over_precision)
```

## Number of 3D points and length measurements over the range limit (EM only)

```{r over_range_limit}
range_limit <- 10 # in metres

over_range <- complete_length %>%
  dplyr::filter(as.numeric(range) > (range_limit* 1000))

message(paste(nrow(over_range), "lengths over range limit"))
glimpse(over_range)
```

## Samples where the MaxN does not equal the number of length measurements


## Percent of MaxN Measured


# Save the checked data
Save MaxN as an R data file.

```{r save-maxn}
saveRDS(complete_count,
          file = here::here(paste0("r-workflows/data/staging/",
                       name, "_complete-count.rds")))
```

Save lengths as an R data file.

```{r save-length}
saveRDS(complete_length,
          file = here::here(paste0("r-workflows/data/staging/",
                       name, "_complete-length.rds")))
```
