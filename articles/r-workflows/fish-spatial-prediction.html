<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Spatially predict fish distributions • CheckEM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Spatially predict fish distributions">
<meta name="google-site-verification" content="m4gXBtqSSJWTmWMwNasopAohP855o_IZ16gJxBTnZ1o">
<!-- Global site tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XRY4CFB9QS"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XRY4CFB9QS');
</script><meta name="google-site-verification" content="m4gXBtqSSJWTmWMwNasopAohP855o_IZ16gJxBTnZ1o">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">CheckEM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-user-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">User Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-user-guides">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Field Manuals</h6></li>
    <li><a class="external-link dropdown-item" href="https://benthic-bruvs-field-manual.github.io/">Baited Remote Underwater Stereo-video (stereo-BRUVs)</a></li>
    <li><a class="external-link dropdown-item" href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13189">Diver Operated Stereo-video (stereo-DOVs)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Annotation Guides</h6></li>
    <li><a class="dropdown-item" href="../../articles/manuals/EventMeasure_annotation_guide.html">Fish annotation guide (EventMeasure)</a></li>
    <li><a class="dropdown-item" href="../../articles/manuals/TransectMeasure_annotation_guide.html">Benthos annotation guide (TransectMeasure)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>CheckEM Guides</h6></li>
    <li><a class="dropdown-item" href="../../articles/manuals/CheckEM_user_guide.html">CheckEM PDF user manual</a></li>
    <li><a class="dropdown-item" href="../../articles/manuals/CheckEM_video.html">CheckEM instructional video</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-r-workflows" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">R Workflows</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-r-workflows">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Create sampling design</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/sampling-design.html">Create a spatially-balanced sampling design using GRTS</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Check Data</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/check-habitat.html">Check habitat data from TransectMeasure</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/check-fish-point.html">Check fish data from single point based methods</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/check-fish-transect.html">Check fish data from transect based methods</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Format Data</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/spatial-layers.html">Generate spatial layers for modelling</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/format-visualise-habitat.html">Format &amp; visualise habitat data</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/format-visualise-fish.html">Format &amp; visualise fish data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/habitat-modelling.html">Generate spatial predictions of habitat using FSSgam</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/fish-modelling.html">Select top models for fish using FSSgam</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/fish-predictions.html">Generate Generalized Additive Model predictions of fish</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/fish-spatial-prediction.html">Spatially predict fish distributions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../articles/community-updates">Improve CheckEM - Contribute to Species Records</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference">Functions</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/GlobalArchiveManual/CheckEM"><span class="fa fa-github"></span> GitHub</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.nespmarinecoastal.edu.au/">ARDC</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Spatially predict fish distributions</h1>
                        <h4 data-toc-skip class="author">Claude Spencer
&amp; Brooke Gibbons</h4>
            
            <h4 data-toc-skip class="date">2023-11-13</h4>
      

      <div class="d-none name"><code>fish-spatial-prediction.Rmd</code></div>
    </div>

    
    
<!-- This script takes the tidy datasets created in the previous steps, uses the top models created in 'Select top models for fish using FSSgam'. Once an appropriate model has been chosen by the user, we then provide R script to spatially predict the response variables and plot these in a tidy format. -->
<!-- ```{r install-fssgam, include=FALSE} -->
<!-- devtools::install_github("beckyfisher/FSSgam_package", upgrade = "never") -->
<!-- ``` -->
<!-- # R setup -->
<!-- Load libraries. All packages are available through CRAN, aside from 'FSSgam', which can be installed following the instructions provided in the GitHub repository https://github.com/beckyfisher/FSSgam.  -->
<!-- ```{r libraries, results='hide', warning=FALSE, message=FALSE} -->
<!-- # install.packages('remotes') -->
<!-- library('remotes') -->
<!-- options(timeout=9999999) -->
<!-- # remotes::install_github("GlobalArchiveManual/CheckEM") -->
<!-- library(CheckEM) -->
<!-- library(tidyverse) -->
<!-- library(mgcv) -->
<!-- library(devtools) -->
<!-- library(FSSgam) -->
<!-- library(here) -->
<!-- library(ggplot2) -->
<!-- library(ggnewscale) -->
<!-- library(viridis) -->
<!-- library(terra) -->
<!-- library(sf) -->
<!-- library(patchwork) -->
<!-- ``` -->
<!-- Set the study name. Study names are used throughout to make for reproducible code that can be easily shifted between different campaigns and projects while still providing meaningful filenames. -->
<!-- ```{r study-name} -->
<!-- name <- 'example-bruv-workflow' -->
<!-- ``` -->
<!-- Load the fish length data. This data is created in the previous workflow, 'Format & visualise fish data'. -->
<!-- ```{r read-length} -->
<!-- tidy.length <- readRDS(here::here(paste0('r-workflows/data/tidy/',  -->
<!--                       name,'_tidy-length.rds'))) %>% -->
<!--   dplyr::filter(!is.na(mbdepth)) %>% # If this filters out any then you need to go back and create your spatial layers -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Load the fish count data. This data is created in the previous workflow, 'Format & visualise fish data'. -->
<!-- ```{r load-count} -->
<!-- tidy.count <- readRDS(here::here(paste0('r-workflows/data/tidy/',  -->
<!--                       name,'_tidy-count.rds'))) %>% -->
<!--   dplyr::filter(!is.na(mbdepth)) %>% # If this filters out any then you need to go back and create your spatial layers -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Combine the count and length data for easy spatial prediction. -->
<!-- ```{r combine-data} -->
<!-- dat <- bind_rows(tidy.count, tidy.length) %>% -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Read in the bathymetry derivatives. -->
<!-- ```{r read-derivatives} -->
<!-- preds  <- readRDS(here::here(paste0("r-workflows/data/spatial/rasters/",  -->
<!--                          name, "_bathymetry_derivatives.rds"))) -->
<!-- plot(preds) -->
<!-- ``` -->
<!-- Transform the spatial bathymetry derivatives into a dataframe to predict onto. -->
<!-- ```{r derivative-dataframe} -->
<!-- preddf <- as.data.frame(preds, xy = TRUE, na.rm = TRUE) %>% -->
<!--   clean_names() %>% -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Manually set the best model from the full subsets model selection process. We select the 'best' model as the most parsimonious model within 2 AICc of the lowest AICc. We suggest you select your models using statistically rigorous criteria that best suits your analysis or project. -->
<!-- ```{r set-models} -->
<!-- # Indicator species greater than size of maturity -->
<!-- m_mature <- gam(number ~  -->
<!--                  s(aspect, k = 3, bs = "cc") + -->
<!--                   s(tpi, k = 3, bs = "cr"),  -->
<!--                data = dplyr::filter(dat, response %in% "greater than Lm"),  -->
<!--                family = tw()) -->
<!-- summary(m_mature) -->
<!-- plot(m_mature, pages = 1, residuals = T, cex = 5) -->
<!-- # Total abundance -->
<!-- m_totabund <- gam(number ~  -->
<!--                   s(detrended, k = 3, bs = "cr"),  -->
<!--                 data = dplyr::filter(dat, response %in% "total_abundance"),  -->
<!--                 family = gaussian(link = "identity")) -->
<!-- summary(m_totabund) -->
<!-- plot(m_totabund, pages = 1, residuals = T, cex = 5) -->
<!-- # Species richness -->
<!-- m_specrich <- gam(number ~  -->
<!--                     s(mbdepth, k = 3, bs = "cr"),  -->
<!--                   data = dplyr::filter(dat, response %in% "species_richness"),  -->
<!--                   family = gaussian(link = "identity")) -->
<!-- summary(m_specrich) -->
<!-- plot(m_specrich, pages = 1, residuals = T, cex = 5) -->
<!-- ``` -->
<!-- Predict each of the response variables across the extent of the bathymetry derivatives. -->
<!-- ```{r predict-gam} -->
<!-- preddf <- cbind(preddf,  -->
<!--                 "pmature" = predict(m_mature, preddf, type = "response"), -->
<!--                 "ptotabund" = predict(m_totabund, preddf, type = "response"), -->
<!--                 "pspecrich" = predict(m_specrich, preddf, type = "response")) %>% -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Save out the spatial predictions. If your computer crashes this way you don't need to run the whole script again. -->
<!-- ```{r save-predictions} -->
<!-- saveRDS(preddf, file = here::here(paste0("r-workflows/model output/fish/",  -->
<!--                               name, "_fish-prediction.RDS"))) -->
<!-- ``` -->
<!-- Pivot the data to long format for easy plotting. -->
<!-- ```{r data-long} -->
<!-- dat <- preddf %>% -->
<!--   dplyr::select(x, y, starts_with("p")) %>% -->
<!--   pivot_longer(names_to = "response", values_to = "value", -->
<!--                cols = !c(x, y)) %>% -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Reset the response variables to loop through when plotting.  -->
<!-- ```{r reset-resp-vars} -->
<!-- resp.vars <- unique(dat$response) -->
<!-- ``` -->
<!-- Load marine park data. The dataset used here is the 2022 Collaborative Australian Protected Areas Database, which is available for free download from https://fed.dcceew.gov.au/datasets/782c02c691014efe8ffbd27445fe41d7_0/explore. Feel free to replace this shapefile with any suitable dataset that is available for your study area. -->
<!-- ```{r marine-parks} -->
<!-- marine.parks <- st_read(here::here("r-workflows/data/spatial/shapefiles/Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine.shp")) %>% -->
<!--   st_make_valid() %>% -->
<!--   dplyr::mutate(ZONE_TYPE = str_replace_all(ZONE_TYPE,  -->
<!--                                             "\\s*\\([^\\)]+\\)", "")) %>% -->
<!--   dplyr::filter(str_detect(ZONE_TYPE, "Sanctuary|National Park"), -->
<!--                 STATE %in% "WA") %>%                         -->
<!--   st_transform(4326) -->
<!-- ``` -->
<!-- Loop through each response variable and create a ggplot figure for each.  -->
<!-- ```{r plot-fish} -->
<!-- for (i in 1:length(resp.vars)) { -->
<!--   use.dat <- dat %>% -->
<!--     dplyr::filter(response %in% resp.vars[i]) -->
<!--   p <- ggplot() + -->
<!--     geom_tile(data = use.dat, aes(x, y, fill = value)) + -->
<!--     scale_fill_gradientn(colours = c("#fde725", "#21918c", "#440154"), na.value = "transparent") + -->
<!--     labs(fill = resp.vars[i], x = NULL, y = NULL) + -->
<!--     new_scale_fill() +                      -->
<!--     geom_sf(data = marine.parks, fill = NA, colour = "#7bbc63",  -->
<!--             size = 0.2, show.legend = F) + -->
<!--     coord_sf(xlim = c(min(dat$x), max(dat$x)), -->
<!--              ylim = c(min(dat$y), max(dat$y))) + -->
<!--     theme_minimal() + -->
<!--     theme(axis.text.x = element_text(size = 7)) -->
<!--   assign(paste0("gg_", resp.vars[i]), p) -->
<!-- } -->
<!-- ``` -->
<!-- Combine the plots using patchwork. -->
<!-- ```{r combine-fish-plots} -->
<!-- gg_pmature + gg_ptotabund + gg_pspecrich + -->
<!--   theme(legend.justification = "left") + -->
<!--   plot_layout(ncol = 2, nrow = 2) -->
<!-- ``` -->
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><img src="https://ardc.edu.au/wp-content/uploads/2022/09/ardc-logo.svg" height="60" alt="ARDC">    <img src="https://www.nespmarinecoastal.edu.au/wp-content/themes/MarineAndCoastalHubTheme/images/logo.svg" height="70" alt="National Environmental Science Program: Marine and Coastal">     Package developed by Brooke Gibbons, Claude Spencer, Tim Langlois.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
