<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Select top models for fish using FSSgam • CheckEM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../../favicon.ico">
<link rel="manifest" href="../../site.webmanifest">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../deps/search-1.0.0/fuse.min.js"></script><script src="../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Select top models for fish using FSSgam">
<meta name="google-site-verification" content="m4gXBtqSSJWTmWMwNasopAohP855o_IZ16gJxBTnZ1o">
<!-- Global site tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XRY4CFB9QS"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XRY4CFB9QS');
</script><meta name="google-site-verification" content="m4gXBtqSSJWTmWMwNasopAohP855o_IZ16gJxBTnZ1o">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">CheckEM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-user-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">User Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-user-guides">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Field Manuals</h6></li>
    <li><a class="external-link dropdown-item" href="https://benthic-bruvs-field-manual.github.io/">Baited Remote Underwater Stereo-video (stereo-BRUVs)</a></li>
    <li><a class="external-link dropdown-item" href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13189">Diver Operated Stereo-video (stereo-DOVs)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Annotation Guides</h6></li>
    <li><a class="dropdown-item" href="../../articles/manuals/EventMeasure_annotation_guide.html">Fish annotation guide (EventMeasure)</a></li>
    <li><a class="dropdown-item" href="../../articles/manuals/TransectMeasure_annotation_guide.html">Benthos annotation guide (TransectMeasure)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>CheckEM Guides</h6></li>
    <li><a class="dropdown-item" href="../../articles/manuals/CheckEM_user_guide.html">CheckEM PDF user manual</a></li>
    <li><a class="dropdown-item" href="../../articles/manuals/CheckEM_video.html">CheckEM instructional video</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-r-workflows" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">R Workflows</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-r-workflows">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Create sampling design</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/sampling-design.html">Create a spatially-balanced sampling design using GRTS</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Check Data</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/check-habitat.html">Check habitat data from TransectMeasure</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/check-fish-point.html">Check fish data from single point based methods</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/check-fish-transect.html">Check fish data from transect based methods</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Format Data</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/spatial-layers.html">Generate spatial layers for modelling</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/format-visualise-habitat.html">Format &amp; visualise habitat data</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/format-visualise-fish.html">Format &amp; visualise fish data</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Modelling</h6></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/habitat-modelling.html">Generate spatial predictions of habitat using FSSgam</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/fish-modelling.html">Select top models for fish using FSSgam</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/fish-predictions.html">Generate Generalized Additive Model predictions of fish</a></li>
    <li><a class="dropdown-item" href="../../articles/r-workflows/fish-spatial-prediction.html">Spatially predict fish distributions</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../../articles/community-updates">Improve CheckEM - Contribute to Species Records</a></li>
<li class="nav-item"><a class="nav-link" href="../../reference">Functions</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/GlobalArchiveManual/CheckEM"><span class="fa fa-github"></span> GitHub</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://www.nespmarinecoastal.edu.au/">ARDC</a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Select top models for fish using FSSgam</h1>
                        <h4 data-toc-skip class="author">Claude Spencer
&amp; Brooke Gibbons</h4>
            
            <h4 data-toc-skip class="date">2023-11-13</h4>
      

      <div class="d-none name"><code>fish-modelling.Rmd</code></div>
    </div>

    
    
<p>This script takes the tidy datasets created in the previous steps and
runs model selection. The model selection process utilises the ‘FSSgam’
package created by Becky Fisher, to investigate relationships between
predictors and response variables, and create sensible models. Once an
appropriate model has been chosen by the user, we then provide R script
to spatially predict the response variables and plot these in a tidy
format.</p>
<!-- ```{r install-fssgam, include=FALSE} -->
<!-- devtools::install_github("beckyfisher/FSSgam_package", upgrade = "never") -->
<!-- ``` -->
<!-- # R setup -->
<!-- Load libraries. All packages are available through CRAN, aside from 'FSSgam', which can be installed following the instructions provided in the GitHub repository https://github.com/beckyfisher/FSSgam.  -->
<!-- ```{r libraries, results='hide', warning=FALSE, message=FALSE} -->
<!-- # install.packages('remotes') -->
<!-- library('remotes') -->
<!-- options(timeout=9999999) -->
<!-- # remotes::install_github("GlobalArchiveManual/CheckEM") -->
<!-- library(CheckEM) -->
<!-- library(tidyverse) -->
<!-- library(mgcv) -->
<!-- library(devtools) -->
<!-- library(FSSgam) -->
<!-- library(here) -->
<!-- library(ggplot2) -->
<!-- library(ggnewscale) -->
<!-- library(viridis) -->
<!-- library(terra) -->
<!-- library(sf) -->
<!-- library(patchwork) -->
<!-- ``` -->
<!-- Set the study name. Study names are used throughout to make for reproducible code that can be easily shifted between different campaigns and projects while still providing meaningful filenames. -->
<!-- ```{r study-name} -->
<!-- name <- 'example-bruv-workflow' -->
<!-- ``` -->
<!-- Load the fish count data. This data is created in the previous workflow, 'Format & visualise fish data'. -->
<!-- ```{r load-count} -->
<!-- tidy.count <- readRDS(here::here(paste0('r-workflows/data/tidy/',  -->
<!--                       name,'_tidy-count.rds'))) %>% -->
<!--   dplyr::filter(!is.na(mbdepth)) %>% # If this filters out any then you need to go back and create your spatial layers -->
<!--   glimpse() -->
<!-- ``` -->
<!-- # Set up data for modelling -->
<!-- Set the potential predictor variables that may be used to explain the patterns found in the response variables. It is important here to select ecologically meaningful variables that could influence the chosen response variable.  -->
<!-- ```{r pred-vars} -->
<!-- pred.vars <- c("mbdepth", "roughness", "slope", "detrended", -->
<!--                "tpi", "tri", "aspect", "reef")  -->
<!-- ``` -->
<!-- Create a correlation matrix to assess correlations between predictor variables. If any variables have a correlation greater than 0.95, then only one of these variables should be included in the model selection. In this example data set, 'roughness', 'slope' and 'tri' are all highly correlated, so we will only include roughness as a final predictor variable.  -->
<!-- ```{r correlations} -->
<!-- round(cor(tidy.count[ , pred.vars]), 2) -->
<!-- ``` -->
<!-- Plot the individual predictors to assess if any transformations are necessary. We suggest to only use transformations when absolutely necessary. In the example data set, most of the response variables have relatively balanced distributions, and therefor we have left them untransformed. It is important to note that in this example dataset, the spread of most predictor variables across their full range is not ideal, with gaps in key predictors such as depth and detrended bathymetry. When working with GAMs, gaps and outliers like this may create spurious relationships, and therefor we suggest running these scripts with more complete data than the small example data set provided here. -->
<!-- ```{r transformations, warning = FALSE, message = FALSE} -->
<!-- CheckEM::plot_transformations(pred.vars = pred.vars, dat = tidy.count) -->
<!-- ``` -->
<!-- Reset the predictor variables to remove any highly correlated variables and include any transformed variables. -->
<!-- ```{r reset-pred-vars} -->
<!-- pred.vars <- c("mbdepth", "roughness", "detrended", -->
<!--                "tpi", "aspect", "reef")  -->
<!-- ``` -->
<!-- Check to make sure response variables have less than 80% zeroes. Full-subset GAM modelling will produce unreliable results if your data is too zero inflated. -->
<!-- ```{r check-responses} -->
<!-- unique.vars <- unique(as.character(tidy.count$response)) -->
<!-- resp.vars <- character() -->
<!-- for(i in 1:length(unique.vars)){ -->
<!--   temp.dat <- tidy.count[which(tidy.count$response == unique.vars[i]), ] -->
<!--   if(length(which(temp.dat$number == 0)) / nrow(temp.dat) < 0.8){ -->
<!--     resp.vars <- c(resp.vars, unique.vars[i])} -->
<!-- } -->
<!-- resp.vars   -->
<!-- ``` -->
<!-- Add the directory to save model outputs, and set up the R environment for model selection. -->
<!-- ```{r environment-setup} -->
<!-- outdir <- ("r-workflows/model output/fish/")  -->
<!-- out.all <- list() -->
<!-- var.imp <- list() -->
<!-- ``` -->
<!-- # Run the full subset model selection process for count metrics -->
<!-- This loop has been adapted from @beckyfisher/FSSgam, and examples and documentation is available on GitHub and in Fisher, R, Wilson, SK, Sin, TM, Lee, AC, Langlois, TJ. A simple function for full-subsets multiple regression in ecology with R. Ecol Evol. 2018; 8: 6104–6113. https://doi.org/10.1002/ece3.4134. -->
<!-- ```{r FSSgam-count, results='hide', warning=FALSE, message=FALSE} -->
<!-- for(i in 1:length(resp.vars)){ -->
<!--   use.dat = as.data.frame(tidy.count[which(tidy.count$response == resp.vars[i]),]) -->
<!--   print(resp.vars[i]) -->
<!--   Model1  <- gam(number ~ s(mbdepth, k = 3, bs = 'cr'), -->
<!--                  family = gaussian(link = "identity"),  data = use.dat) -->
<!--   model.set <- generate.model.set(use.dat = use.dat, -->
<!--                                test.fit = Model1, -->
<!--                                pred.vars.cont = pred.vars, -->
<!--                                factor.smooth.interactions = NA, -->
<!--                                cyclic.vars = "aspect", -->
<!--                                k = 3) -->
<!--   out.list <- fit.model.set(model.set, -->
<!--                          max.models = 600, -->
<!--                          parallel = T) -->
<!--   names(out.list) -->
<!--   out.list$failed.models  -->
<!--   mod.table = out.list$mod.data.out  -->
<!--   mod.table = mod.table[order(mod.table$AICc),] -->
<!--   mod.table$cumsum.wi = cumsum(mod.table$wi.AICc) -->
<!--   out.i = mod.table[which(mod.table$delta.AICc <= 2),] -->
<!--   out.all = c(out.all,list(out.i)) -->
<!--   var.imp = c(var.imp,list(out.list$variable.importance$aic$variable.weights.raw)) -->
<!--   for(m in 1:nrow(out.i)){ -->
<!--     best.model.name = as.character(out.i$modname[m]) -->
<!--     png(file = here::here(paste(outdir, paste(name, m, resp.vars[i], "mod_fits.png", sep = "_"), sep = "/"))) -->
<!--     if(best.model.name != "null"){ -->
<!--       par(mfrow = c(3,1), mar = c(9, 4, 3, 1)) -->
<!--       best.model = out.list$success.models[[best.model.name]] -->
<!--       plot(best.model, all.terms = T,pages = 1,residuals = T,pch = 16) -->
<!--       mtext(side = 2, text = resp.vars[i], outer = F)}   -->
<!--     dev.off() -->
<!--   } -->
<!-- } -->
<!-- ``` -->
<!-- Tidy the model fits and importance scores. These will be combined with the models fits and importance scores from the model selection for lenght metrics. -->
<!-- ```{r save-gam-data} -->
<!-- names(out.all) <- resp.vars -->
<!-- names(var.imp) <- resp.vars -->
<!-- all.mod.fits <- list_rbind(out.all, names_to = "response") -->
<!-- all.var.imp  <- as.data.frame(do.call("rbind", var.imp)) -->
<!-- ``` -->
<!-- Load the fish length data. This data is created in the previous workflow, 'Format & visualise fish data'. -->
<!-- ```{r read-length} -->
<!-- tidy.length <- readRDS(here::here(paste0('r-workflows/data/tidy/',  -->
<!--                       name,'_tidy-length.rds'))) %>% -->
<!--   dplyr::filter(!is.na(mbdepth)) %>% # If this filters out any then you need to go back and create your spatial layers -->
<!--   glimpse() -->
<!-- ``` -->
<!-- Check to make sure response variables have less than 80% zeroes. Full-subset GAM modelling will produce unreliable results if your data is too zero inflated. -->
<!-- ```{r length-responses} -->
<!-- unique.vars <- unique(as.character(tidy.length$response)) -->
<!-- resp.vars <- character() -->
<!-- for(i in 1:length(unique.vars)){ -->
<!--   temp.dat <- tidy.length[which(tidy.length$response == unique.vars[i]), ] -->
<!--   if(length(which(temp.dat$number == 0)) / nrow(temp.dat) < 0.8){ -->
<!--     resp.vars <- c(resp.vars, unique.vars[i])} -->
<!-- } -->
<!-- resp.vars  -->
<!-- ``` -->
<!-- Set up the R environment for model selection. -->
<!-- ```{r set-up} -->
<!-- out.all = list() -->
<!-- var.imp = list() -->
<!-- ``` -->
<!-- # Run the full subset model selection process for length metrics -->
<!-- This loop has been adapted from @beckyfisher/FSSgam, and examples and documentation is available on GitHub and in Fisher, R, Wilson, SK, Sin, TM, Lee, AC, Langlois, TJ. A simple function for full-subsets multiple regression in ecology with R. Ecol Evol. 2018; 8: 6104–6113. https://doi.org/10.1002/ece3.4134. -->
<!-- ```{r FSSgam-length, results='hide', warning=FALSE, message=FALSE} -->
<!-- for(i in 1:length(resp.vars)){ -->
<!--   use.dat = as.data.frame(tidy.length[which(tidy.length$response == resp.vars[i]),]) -->
<!--   print(resp.vars[i]) -->
<!--   Model1  <- gam(number ~ s(mbdepth, k = 3, bs = 'cr'), -->
<!--                  family = tw(),  data = use.dat) -->
<!--   model.set <- generate.model.set(use.dat = use.dat, -->
<!--                                test.fit = Model1, -->
<!--                                pred.vars.cont = pred.vars, -->
<!--                                factor.smooth.interactions = NA, -->
<!--                                cyclic.vars = "aspect",  -->
<!--                                k = 3 -->
<!--                                ) -->
<!--   out.list <- fit.model.set(model.set, -->
<!--                          max.models = 600, -->
<!--                          parallel = T) -->
<!--   names(out.list) -->
<!--   out.list$failed.models -->
<!--   mod.table = out.list$mod.data.out -->
<!--   mod.table = mod.table[order(mod.table$AICc),] -->
<!--   mod.table$cumsum.wi = cumsum(mod.table$wi.AICc) -->
<!--   out.i = mod.table[which(mod.table$delta.AICc<=2),] -->
<!--   out.all = c(out.all, list(out.i)) -->
<!--   var.imp = c(var.imp, list(out.list$variable.importance$aic$variable.weights.raw)) -->
<!--   for(m in 1:nrow(out.i)){ -->
<!--     best.model.name = as.character(out.i$modname[m]) -->
<!--     png(file = here::here(paste(outdir, paste(name, m, resp.vars[i], "mod_fits.png", sep = "_"), sep = "/"))) -->
<!--     if(best.model.name != "null"){ -->
<!--       par(mfrow = c(3,1), mar = c(9, 4, 3, 1)) -->
<!--       best.model = out.list$success.models[[best.model.name]] -->
<!--       plot(best.model, all.terms = T, pages = 1, residuals = T, pch = 16) -->
<!--       mtext(side = 2, text = resp.vars[i], outer = F)}   -->
<!--     dev.off() -->
<!--   } -->
<!-- } -->
<!-- ``` -->
<!-- Combine the model fits and importance scores with those previously created in full subsets modelling of count metrics, and save out these files. -->
<!-- ```{r save-outputs} -->
<!-- names(out.all) <- resp.vars -->
<!-- names(var.imp) <- resp.vars -->
<!-- all.mod.fits <- bind_rows(all.mod.fits, list_rbind(out.all, names_to = "response")) -->
<!-- all.var.imp  <- bind_rows(all.var.imp, as.data.frame(do.call("rbind",var.imp))) -->
<!-- write.csv(all.mod.fits[ , -2], file = here::here(paste0(outdir, name, "_all.mod.fits.csv"))) -->
<!-- write.csv(all.var.imp,         file = here::here(paste0(outdir, name, "_all.var.imp.csv"))) -->
<!-- ``` -->
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p><img src="https://ardc.edu.au/wp-content/uploads/2022/09/ardc-logo.svg" height="60" alt="ARDC">    <img src="https://www.nespmarinecoastal.edu.au/wp-content/themes/MarineAndCoastalHubTheme/images/logo.svg" height="70" alt="National Environmental Science Program: Marine and Coastal">     Package developed by Brooke Gibbons, Claude Spencer, Tim Langlois.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
