<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="CheckEM">
<title>Generate spatial predictions of fish using FSSgam • CheckEM</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Generate spatial predictions of fish using FSSgam">
<meta property="og:description" content="CheckEM">
<meta property="og:image" content="https://globalarchivemanual.github.io/CheckEM/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) --><script async src="https://www.googletagmanager.com/gtag/js?id=G-XRY4CFB9QS"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XRY4CFB9QS');
</script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-default navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">CheckEM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-user-guides">User Guides</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-user-guides">
    <h6 class="dropdown-header" data-toc-skip>Field Manuals</h6>
    <a class="external-link dropdown-item" href="https://benthic-bruvs-field-manual.github.io/">Baited Remote Underwater Stereo-video (stereo-BRUVs)</a>
    <a class="external-link dropdown-item" href="https://besjournals.onlinelibrary.wiley.com/doi/full/10.1111/2041-210X.13189">Diver Operated Stereo-video (stereo-DOVs)</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Annotation Guides</h6>
    <a class="dropdown-item" href="../../articles/manuals/EventMeasure_annotation_guide.html">Fish annotation guide (EventMeasure)</a>
    <a class="dropdown-item" href="../../articles/manuals/TransectMeasure_annotation_guide.html">Benthos annotation guide (TransectMeasure)</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>CheckEM Guides</h6>
    <a class="dropdown-item" href="../../articles/manuals/CheckEM_user_guide.html">CheckEM PDF user manual</a>
    <a class="dropdown-item" href="../../articles/manuals/CheckEM_video.html">CheckEM instructional video</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-r-workflows">R Workflows</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-r-workflows">
    <h6 class="dropdown-header" data-toc-skip>Check Data</h6>
    <a class="dropdown-item" href="../../articles/r-workflows/check-habitat.html">Check habitat data from TransectMeasure</a>
    <a class="dropdown-item" href="../../articles/r-workflows/check-fish.html">Check fish data from EventMeasure</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Format Data</h6>
    <a class="dropdown-item" href="../../articles/r-workflows/spatial-layers.html">Generate spatial layers for modelling</a>
    <a class="dropdown-item" href="../../articles/r-workflows/format-visualise-habitat.html">Format &amp; visualise habitat data</a>
    <a class="dropdown-item" href="../../articles/r-workflows/format-visualise-fish.html">Format &amp; visualise fish data</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Modelling</h6>
    <a class="dropdown-item" href="../../articles/r-workflows/habitat-modelling.html">Generate spatial predictions of habitat using FSSgam</a>
    <a class="dropdown-item" href="../../articles/r-workflows/fish-modelling.html">Generate spatial predictions of fish using FSSgam</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../reference/r-workflows/index.html">Functions</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/GlobalArchiveManual/CheckEM" aria-label="GitHub">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.nespmarinecoastal.edu.au/" aria-label="ARDC"></a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Generate spatial predictions of fish using FSSgam</h1>
                        <h4 data-toc-skip class="author">Claude Spencer
&amp; Brooke Gibbons</h4>
            
            <h4 data-toc-skip class="date">2023-11-13</h4>
      
      
      <div class="d-none name"><code>fish-modelling.Rmd</code></div>
    </div>

    
    
<p>This script takes the tidy datasets created in the previous steps,
and runs model selection, spatial prediction and tidy spatial plotting.
The model selection process utilises the ‘FSSgam’ package created by
Becky Fisher, to investigate relationships between predictors and
response variables, and create sensible models. Once an appropriate
model has been chosen by the user, we then provide R script to spatially
predict the response variables and plot these in a tidy format.</p>
<div class="section level2">
<h2 id="r-setup">R setup<a class="anchor" aria-label="anchor" href="#r-setup"></a>
</h2>
<p>Load libraries. All packages are available through CRAN, aside from
‘FSSgam’, which can be installed following the instructions provided in
the GitHub repository <a href="https://github.com/beckyfisher/FSSgam" class="external-link uri">https://github.com/beckyfisher/FSSgam</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://globalarchivemanual.github.io/CheckEM/">CheckEM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://devtools.r-lib.org/" class="external-link">devtools</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">FSSgam</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://eliocamp.github.io/ggnewscale/" class="external-link">ggnewscale</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/" class="external-link">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span></code></pre></div>
<p>Set the study name. Study names are used throughout to make for
reproducible code that can be easily shifted between different campaigns
and projects while still providing meaningful filenames.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">name</span> <span class="op">&lt;-</span> <span class="st">'example-bruv-workflow'</span></span></code></pre></div>
<p>Load the fish count data. This data is created in the previous
workflow, ‘Format &amp; visualise fish data’.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidy.count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'r-workflows/data/tidy/'</span>, </span>
<span>                      <span class="va">name</span>,<span class="st">'_tidy-count.rds'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mbdepth</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># If this filters out any then you need to go back and create your spatial layers</span></span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 64</span></span>
<span><span class="co">## Columns: 17</span></span>
<span><span class="co">## $ campaignid   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "2023-03_SwC_stereo-BRUVs", "2023-03_SwC_stereo-BRUVs", "…</span></span>
<span><span class="co">## $ sample       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "10", "10", "12", "12", "14", "14", "15", "15", "16", "16…</span></span>
<span><span class="co">## $ response     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "total_abundance", "species_richness", "total_abundance",…</span></span>
<span><span class="co">## $ number       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 111, 13, 94, 15, 191, 9, 146, 16, 99, 14, 312, 18, 38, 13…</span></span>
<span><span class="co">## $ longitude_dd <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 114.8533, 114.8533, 114.8816, 114.8816, 114.8686, 114.868…</span></span>
<span><span class="co">## $ latitude_dd  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -34.08387, -34.08387, -34.13249, -34.13249, -34.07530, -3…</span></span>
<span><span class="co">## $ depth        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "44.3", "44.3", "42.6", "42.6", "42.7", "42.7", "45.3", "…</span></span>
<span><span class="co">## $ mbdepth      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -42.77519, -42.77519, -42.02835, -42.02835, -41.07679, -4…</span></span>
<span><span class="co">## $ slope        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.005708777, 0.005708777, 0.013768068, 0.013768068, 0.078…</span></span>
<span><span class="co">## $ aspect       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 72.31942, 72.31942, 110.35012, 110.35012, 215.54254, 215.…</span></span>
<span><span class="co">## $ tpi          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.05208921, 0.05208921, 0.03892708, 0.03892708, 0.2611088…</span></span>
<span><span class="co">## $ tri          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.05208921, 0.05208921, 0.06246567, 0.06246567, 0.3096442…</span></span>
<span><span class="co">## $ roughness    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.11757660, 0.11757660, 0.30690765, 0.30690765, 0.7959022…</span></span>
<span><span class="co">## $ detrended    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -2.8542883, -2.8542883, -5.8822656, -5.8822656, -6.646017…</span></span>
<span><span class="co">## $ mean_relief  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3.217391, 3.217391, 2.809524, 2.809524, 2.440000, 2.44000…</span></span>
<span><span class="co">## $ sd_relief    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.7952428, 0.7952428, 0.4023739, 0.4023739, 0.7118052, 0.…</span></span>
<span><span class="co">## $ reef         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.9690722, 0.9690722, 1.0000000, 1.0000000, 0.9420290, 0.…</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="set-up-data-for-modelling">Set up data for modelling<a class="anchor" aria-label="anchor" href="#set-up-data-for-modelling"></a>
</h2>
<p>Set the potential predictor variables that may be used to explain the
patterns found in the response variables. It is important here to select
ecologically meaningful variables that could influence the chosen
response variable.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mbdepth"</span>, <span class="st">"roughness"</span>, <span class="st">"slope"</span>, <span class="st">"detrended"</span>,</span>
<span>               <span class="st">"tpi"</span>, <span class="st">"tri"</span>, <span class="st">"aspect"</span>, <span class="st">"reef"</span><span class="op">)</span> </span></code></pre></div>
<p>Create a correlation matrix to assess correlations between predictor
variables. If any variables have a correlation greater than 0.95, then
only one of these variables should be included in the model selection.
In this example data set, ‘roughness’, ‘slope’ and ‘tri’ are all highly
correlated, so we will only include roughness as a final predictor
variable.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/math-generics.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">tidy.count</span><span class="op">[</span> , <span class="va">pred.vars</span><span class="op">]</span><span class="op">)</span>, <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           mbdepth roughness slope detrended   tpi   tri aspect  reef</span></span>
<span><span class="co">## mbdepth      1.00     -0.66 -0.65     -0.89  0.03 -0.59  -0.32 -0.17</span></span>
<span><span class="co">## roughness   -0.66      1.00  0.99      0.48  0.29  0.99   0.06  0.19</span></span>
<span><span class="co">## slope       -0.65      0.99  1.00      0.47  0.29  0.99   0.06  0.18</span></span>
<span><span class="co">## detrended   -0.89      0.48  0.47      1.00  0.00  0.42   0.39  0.34</span></span>
<span><span class="co">## tpi          0.03      0.29  0.29      0.00  1.00  0.35  -0.02  0.01</span></span>
<span><span class="co">## tri         -0.59      0.99  0.99      0.42  0.35  1.00   0.04  0.19</span></span>
<span><span class="co">## aspect      -0.32      0.06  0.06      0.39 -0.02  0.04   1.00 -0.05</span></span>
<span><span class="co">## reef        -0.17      0.19  0.18      0.34  0.01  0.19  -0.05  1.00</span></span></code></pre>
<p>Plot the individual predictors to assess if any transformations are
necessary. We suggest to only use transformations when absolutely
necessary. In the example data set, most of the response variables have
relatively balanced distributions, and therefor we have left them
untransformed. It is important to note that in this example dataset, the
spread of most predictor variables across their full range is not ideal,
with gaps in key predictors such as depth and detrended bathymetry. When
working with GAMs, gaps and outliers like this may create spurious
relationships, and therefor we suggest running these scripts with more
complete data than the small example data set provided here.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">CheckEM</span><span class="fu">::</span><span class="fu"><a href="../../reference/plot_transformations.html">plot_transformations</a></span><span class="op">(</span>pred.vars <span class="op">=</span> <span class="va">pred.vars</span>, dat <span class="op">=</span> <span class="va">tidy.count</span><span class="op">)</span></span></code></pre></div>
<p><img src="fish-modelling_files/figure-html/transformations-1.png" width="700"><img src="fish-modelling_files/figure-html/transformations-2.png" width="700"><img src="fish-modelling_files/figure-html/transformations-3.png" width="700"><img src="fish-modelling_files/figure-html/transformations-4.png" width="700"><img src="fish-modelling_files/figure-html/transformations-5.png" width="700"><img src="fish-modelling_files/figure-html/transformations-6.png" width="700"><img src="fish-modelling_files/figure-html/transformations-7.png" width="700"><img src="fish-modelling_files/figure-html/transformations-8.png" width="700"></p>
<p>Reset the predictor variables to remove any highly correlated
variables and include any transformed variables.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mbdepth"</span>, <span class="st">"roughness"</span>, <span class="st">"detrended"</span>,</span>
<span>               <span class="st">"tpi"</span>, <span class="st">"aspect"</span>, <span class="st">"reef"</span><span class="op">)</span> </span></code></pre></div>
<p>Check to make sure response variables have less than 80% zeroes.
Full-subset GAM modelling will produce unreliable results if your data
is too zero inflated.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unique.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">tidy.count</span><span class="op">$</span><span class="va">response</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resp.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unique.vars</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temp.dat</span> <span class="op">&lt;-</span> <span class="va">tidy.count</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tidy.count</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="va">unique.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">temp.dat</span><span class="op">$</span><span class="va">number</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">temp.dat</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">resp.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">resp.vars</span>, <span class="va">unique.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">resp.vars</span>  </span></code></pre></div>
<pre><code><span><span class="co">## [1] "total_abundance"  "species_richness"</span></span></code></pre>
<p>Add the directory to save model outputs, and set up the R environment
for model selection.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">outdir</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="st">"r-workflows/model output/fish/"</span><span class="op">)</span> </span>
<span><span class="va">out.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">var.imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-the-full-subset-model-selection-process-for-count-metrics">Run the full subset model selection process for count metrics<a class="anchor" aria-label="anchor" href="#run-the-full-subset-model-selection-process-for-count-metrics"></a>
</h2>
<p>This loop has been adapted from <span class="citation">@beckyfisher/FSSgam</span>, and examples and
documentation is available on GitHub and in Fisher, R, Wilson, SK, Sin,
TM, Lee, AC, Langlois, TJ. A simple function for full-subsets multiple
regression in ecology with R. Ecol Evol. 2018; 8: 6104–6113. <a href="https://doi.org/10.1002/ece3.4134" class="external-link uri">https://doi.org/10.1002/ece3.4134</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resp.vars</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">use.dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">tidy.count</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tidy.count</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">Model1</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">number</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">mbdepth</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">'cr'</span><span class="op">)</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span>,  data <span class="op">=</span> <span class="va">use.dat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">model.set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FSSgam/man/generate.model.set.html" class="external-link">generate.model.set</a></span><span class="op">(</span>use.dat <span class="op">=</span> <span class="va">use.dat</span>,</span>
<span>                               test.fit <span class="op">=</span> <span class="va">Model1</span>,</span>
<span>                               pred.vars.cont <span class="op">=</span> <span class="va">pred.vars</span>,</span>
<span>                               factor.smooth.interactions <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                               k <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">out.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FSSgam/man/fit.model.set.html" class="external-link">fit.model.set</a></span><span class="op">(</span><span class="va">model.set</span>,</span>
<span>                         max.models <span class="op">=</span> <span class="fl">600</span>,</span>
<span>                         parallel <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out.list</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out.list</span><span class="op">$</span><span class="va">failed.models</span> </span>
<span>  <span class="va">mod.table</span> <span class="op">=</span> <span class="va">out.list</span><span class="op">$</span><span class="va">mod.data.out</span> </span>
<span>  <span class="va">mod.table</span> <span class="op">=</span> <span class="va">mod.table</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">mod.table</span><span class="op">$</span><span class="va">AICc</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">mod.table</span><span class="op">$</span><span class="va">cumsum.wi</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">mod.table</span><span class="op">$</span><span class="va">wi.AICc</span><span class="op">)</span></span>
<span>  <span class="va">out.i</span> <span class="op">=</span> <span class="va">mod.table</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mod.table</span><span class="op">$</span><span class="va">delta.AICc</span> <span class="op">&lt;=</span> <span class="fl">2</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">out.all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">out.all</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">out.i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">var.imp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">var.imp</span>,<span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">out.list</span><span class="op">$</span><span class="va">variable.importance</span><span class="op">$</span><span class="va">aic</span><span class="op">$</span><span class="va">variable.weights.raw</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">out.i</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">best.model.name</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">out.i</span><span class="op">$</span><span class="va">modname</span><span class="op">[</span><span class="va">m</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">outdir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">m</span>, <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"mod_fits.png"</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">best.model.name</span> <span class="op">!=</span> <span class="st">"null"</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">best.model</span> <span class="op">=</span> <span class="va">out.list</span><span class="op">$</span><span class="va">success.models</span><span class="op">[[</span><span class="va">best.model.name</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">best.model</span>, all.terms <span class="op">=</span> <span class="cn">T</span>,pages <span class="op">=</span> <span class="fl">1</span>,residuals <span class="op">=</span> <span class="cn">T</span>,pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span>side <span class="op">=</span> <span class="fl">2</span>, text <span class="op">=</span> <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, outer <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">}</span>  </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Tidy the model fits and importance scores. These will be combined
with the models fits and importance scores from the model selection for
lenght metrics.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resp.vars</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">var.imp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resp.vars</span></span>
<span><span class="va">all.mod.fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="va">out.all</span>, names_to <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">all.var.imp</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">var.imp</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Load the fish length data. This data is created in the previous
workflow, ‘Format &amp; visualise fish data’.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidy.length</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'r-workflows/data/tidy/'</span>, </span>
<span>                      <span class="va">name</span>,<span class="st">'_tidy-length.rds'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">mbdepth</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># If this filters out any then you need to go back and create your spatial layers</span></span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 64</span></span>
<span><span class="co">## Columns: 18</span></span>
<span><span class="co">## $ campaignid   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "2023-03_SwC_stereo-BRUVs", "2023-03_SwC_stereo-BRUVs", "…</span></span>
<span><span class="co">## $ sample       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "15", "17", "19", "23", "24", "26", "29", "3", "31", "32"…</span></span>
<span><span class="co">## $ number       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 1, 1, 8, 3, 2, 3, 4, 1, 4, 6, 1, 3, 1, 2, 4, 2, 6, 1, 13,…</span></span>
<span><span class="co">## $ status       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "No-take", "No-take", "No-take", "No-take", "No-take", "N…</span></span>
<span><span class="co">## $ response     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "greater than Lm", "greater than Lm", "greater than Lm", …</span></span>
<span><span class="co">## $ longitude_dd <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 114.8444, 114.8576, 114.7822, 114.9190, 114.8485, 114.928…</span></span>
<span><span class="co">## $ latitude_dd  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -34.08478, -34.09635, -34.12047, -34.12832, -34.11789, -3…</span></span>
<span><span class="co">## $ depth        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "45.3", "43.3", "73.6", "41", "45.6", "36", "42.6", "46.7…</span></span>
<span><span class="co">## $ mbdepth      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -44.29804, -42.74676, -71.60112, -38.25594, -44.23959, -4…</span></span>
<span><span class="co">## $ slope        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.108975978, 0.008719478, 0.880997142, 0.444838455, 0.103…</span></span>
<span><span class="co">## $ aspect       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 264.03427, 30.76545, 262.35388, 294.10675, 257.20307, 40.…</span></span>
<span><span class="co">## $ tpi          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.19527912, 0.02505112, 1.04176044, 0.47694588, 0.042278…</span></span>
<span><span class="co">## $ tri          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.34487247, 0.03473282, 2.80258274, 1.83670998, 0.3347983…</span></span>
<span><span class="co">## $ roughness    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.91366196, 0.09923935, 9.01136017, 5.30128479, 1.2933082…</span></span>
<span><span class="co">## $ detrended    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -0.2281526, -3.1375041, 17.9911461, -8.6934719, 2.9724391…</span></span>
<span><span class="co">## $ mean_relief  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.518519, 3.333333, 2.583333, 3.555556, 3.360000, 4.00000…</span></span>
<span><span class="co">## $ sd_relief    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.8024180, 0.9128709, 0.5036102, 0.8555853, 0.4898979, 0.…</span></span>
<span><span class="co">## $ reef         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.8292683, 1.0000000, 0.9493671, 1.0000000, 1.0000000, 1.…</span></span></code></pre>
<p>Check to make sure response variables have less than 80% zeroes.
Full-subset GAM modelling will produce unreliable results if your data
is too zero inflated.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">unique.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">tidy.length</span><span class="op">$</span><span class="va">response</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">resp.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unique.vars</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">temp.dat</span> <span class="op">&lt;-</span> <span class="va">tidy.length</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tidy.length</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="va">unique.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">temp.dat</span><span class="op">$</span><span class="va">number</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">temp.dat</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">0.8</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">resp.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">resp.vars</span>, <span class="va">unique.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="va">resp.vars</span> </span></code></pre></div>
<pre><code><span><span class="co">## [1] "greater than Lm"</span></span></code></pre>
<p>Set up the R environment for model selection.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out.all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">var.imp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="run-the-full-subset-model-selection-process-for-length-metrics">Run the full subset model selection process for length metrics<a class="anchor" aria-label="anchor" href="#run-the-full-subset-model-selection-process-for-length-metrics"></a>
</h2>
<p>This loop has been adapted from <span class="citation">@beckyfisher/FSSgam</span>, and examples and
documentation is available on GitHub and in Fisher, R, Wilson, SK, Sin,
TM, Lee, AC, Langlois, TJ. A simple function for full-subsets multiple
regression in ecology with R. Ecol Evol. 2018; 8: 6104–6113. <a href="https://doi.org/10.1002/ece3.4134" class="external-link uri">https://doi.org/10.1002/ece3.4134</a>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resp.vars</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">use.dat</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">tidy.length</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tidy.length</span><span class="op">$</span><span class="va">response</span> <span class="op">==</span> <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">Model1</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">number</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">mbdepth</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">'cr'</span><span class="op">)</span>,</span>
<span>                 family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span><span class="op">(</span><span class="op">)</span>,  data <span class="op">=</span> <span class="va">use.dat</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">model.set</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FSSgam/man/generate.model.set.html" class="external-link">generate.model.set</a></span><span class="op">(</span>use.dat <span class="op">=</span> <span class="va">use.dat</span>,</span>
<span>                               test.fit <span class="op">=</span> <span class="va">Model1</span>,</span>
<span>                               pred.vars.cont <span class="op">=</span> <span class="va">pred.vars</span>,</span>
<span>                               factor.smooth.interactions <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>                               k <span class="op">=</span> <span class="fl">3</span></span>
<span>                               <span class="op">)</span></span>
<span>  <span class="va">out.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/FSSgam/man/fit.model.set.html" class="external-link">fit.model.set</a></span><span class="op">(</span><span class="va">model.set</span>,</span>
<span>                         max.models <span class="op">=</span> <span class="fl">600</span>,</span>
<span>                         parallel <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out.list</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">out.list</span><span class="op">$</span><span class="va">failed.models</span></span>
<span>  <span class="va">mod.table</span> <span class="op">=</span> <span class="va">out.list</span><span class="op">$</span><span class="va">mod.data.out</span></span>
<span>  <span class="va">mod.table</span> <span class="op">=</span> <span class="va">mod.table</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">mod.table</span><span class="op">$</span><span class="va">AICc</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">mod.table</span><span class="op">$</span><span class="va">cumsum.wi</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">mod.table</span><span class="op">$</span><span class="va">wi.AICc</span><span class="op">)</span></span>
<span>  <span class="va">out.i</span> <span class="op">=</span> <span class="va">mod.table</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mod.table</span><span class="op">$</span><span class="va">delta.AICc</span><span class="op">&lt;=</span><span class="fl">2</span><span class="op">)</span>,<span class="op">]</span></span>
<span>  <span class="va">out.all</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">out.all</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">out.i</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">var.imp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">var.imp</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">out.list</span><span class="op">$</span><span class="va">variable.importance</span><span class="op">$</span><span class="va">aic</span><span class="op">$</span><span class="va">variable.weights.raw</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">out.i</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">best.model.name</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">out.i</span><span class="op">$</span><span class="va">modname</span><span class="op">[</span><span class="va">m</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png</a></span><span class="op">(</span>file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">outdir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">m</span>, <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="st">"mod_fits.png"</span>, sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="va">best.model.name</span> <span class="op">!=</span> <span class="st">"null"</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">9</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">best.model</span> <span class="op">=</span> <span class="va">out.list</span><span class="op">$</span><span class="va">success.models</span><span class="op">[[</span><span class="va">best.model.name</span><span class="op">]</span><span class="op">]</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">best.model</span>, all.terms <span class="op">=</span> <span class="cn">T</span>, pages <span class="op">=</span> <span class="fl">1</span>, residuals <span class="op">=</span> <span class="cn">T</span>, pch <span class="op">=</span> <span class="fl">16</span><span class="op">)</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span>side <span class="op">=</span> <span class="fl">2</span>, text <span class="op">=</span> <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, outer <span class="op">=</span> <span class="cn">F</span><span class="op">)</span><span class="op">}</span>  </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Combine the model fits and importance scores with those previously
created in full subsets modelling of count metrics, and save out these
files.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out.all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resp.vars</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">var.imp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">resp.vars</span></span>
<span><span class="va">all.mod.fits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">all.mod.fits</span>, <span class="fu"><a href="https://purrr.tidyverse.org/reference/list_c.html" class="external-link">list_rbind</a></span><span class="op">(</span><span class="va">out.all</span>, names_to <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">all.var.imp</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">all.var.imp</span>, <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>,<span class="va">var.imp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">all.mod.fits</span><span class="op">[</span> , <span class="op">-</span><span class="fl">2</span><span class="op">]</span>, file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">outdir</span>, <span class="va">name</span>, <span class="st">"_all.mod.fits.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.csv</a></span><span class="op">(</span><span class="va">all.var.imp</span>,         file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">outdir</span>, <span class="va">name</span>, <span class="st">"_all.var.imp.csv"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Combine the count and length data for easy spatial prediction.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">tidy.count</span>, <span class="va">tidy.length</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 128</span></span>
<span><span class="co">## Columns: 18</span></span>
<span><span class="co">## $ campaignid   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "2023-03_SwC_stereo-BRUVs", "2023-03_SwC_stereo-BRUVs", "…</span></span>
<span><span class="co">## $ sample       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "10", "10", "12", "12", "14", "14", "15", "15", "16", "16…</span></span>
<span><span class="co">## $ response     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "total_abundance", "species_richness", "total_abundance",…</span></span>
<span><span class="co">## $ number       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 111, 13, 94, 15, 191, 9, 146, 16, 99, 14, 312, 18, 38, 13…</span></span>
<span><span class="co">## $ longitude_dd <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 114.8533, 114.8533, 114.8816, 114.8816, 114.8686, 114.868…</span></span>
<span><span class="co">## $ latitude_dd  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -34.08387, -34.08387, -34.13249, -34.13249, -34.07530, -3…</span></span>
<span><span class="co">## $ depth        <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "44.3", "44.3", "42.6", "42.6", "42.7", "42.7", "45.3", "…</span></span>
<span><span class="co">## $ mbdepth      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -42.77519, -42.77519, -42.02835, -42.02835, -41.07679, -4…</span></span>
<span><span class="co">## $ slope        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.005708777, 0.005708777, 0.013768068, 0.013768068, 0.078…</span></span>
<span><span class="co">## $ aspect       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 72.31942, 72.31942, 110.35012, 110.35012, 215.54254, 215.…</span></span>
<span><span class="co">## $ tpi          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.05208921, 0.05208921, 0.03892708, 0.03892708, 0.2611088…</span></span>
<span><span class="co">## $ tri          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.05208921, 0.05208921, 0.06246567, 0.06246567, 0.3096442…</span></span>
<span><span class="co">## $ roughness    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.11757660, 0.11757660, 0.30690765, 0.30690765, 0.7959022…</span></span>
<span><span class="co">## $ detrended    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -2.8542883, -2.8542883, -5.8822656, -5.8822656, -6.646017…</span></span>
<span><span class="co">## $ mean_relief  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 3.217391, 3.217391, 2.809524, 2.809524, 2.440000, 2.44000…</span></span>
<span><span class="co">## $ sd_relief    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.7952428, 0.7952428, 0.4023739, 0.4023739, 0.7118052, 0.…</span></span>
<span><span class="co">## $ reef         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.9690722, 0.9690722, 1.0000000, 1.0000000, 0.9420290, 0.…</span></span>
<span><span class="co">## $ status       <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, N…</span></span></code></pre>
<p>Read in the bathymetry derivatives.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preds</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"r-workflows/data/spatial/rasters/"</span>, </span>
<span>                         <span class="va">name</span>, <span class="st">"_bathymetry_derivatives.rds"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span></span></code></pre></div>
<p><img src="fish-modelling_files/figure-html/read-derivatives-1.png" width="700"></p>
<p>Transform the spatial bathymetry derivatives into a dataframe to
predict onto.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preddf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">preds</span>, xy <span class="op">=</span> <span class="cn">TRUE</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/clean_names.html">clean_names</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 73,350</span></span>
<span><span class="co">## Columns: 9</span></span>
<span><span class="co">## $ x         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 115.1714, 115.1739, 115.1764, 115.1789, 115.1814, 115.1839, …</span></span>
<span><span class="co">## $ y         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -33.60361, -33.60361, -33.60361, -33.60361, -33.60361, -33.6…</span></span>
<span><span class="co">## $ mbdepth   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -14.83014, -13.89184, -14.18757, -14.48647, -14.47323, -14.3…</span></span>
<span><span class="co">## $ slope     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.24350203, 0.19746646, 0.17799167, 0.18316828, 0.22091857, …</span></span>
<span><span class="co">## $ aspect    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 339.995240, 341.597571, 21.180346, 12.600024, 356.337121, 35…</span></span>
<span><span class="co">## $ tpi       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -3.721524e-01, 5.277313e-01, 1.502453e-01, -1.123428e-03, 9.…</span></span>
<span><span class="co">## $ tri       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.9656481, 0.8277034, 0.6934198, 0.6945946, 0.8081013, 0.902…</span></span>
<span><span class="co">## $ roughness <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.807414, 2.421717, 2.196986, 2.156502, 2.581898, 2.606502, …</span></span>
<span><span class="co">## $ detrended <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -2.871674, -2.161609, -2.683798, -3.207528, -3.417629, -3.56…</span></span></code></pre>
<p>Manually set the best model from the full subsets model selection
process. We select the ‘best’ model as the most parsimonious model
within 2 AICc of the lowest AICc. We suggest you select your models
using statistically rigorous criteria that best suits your analysis or
project.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Indicator species greater than size of maturity</span></span>
<span><span class="va">m_mature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">number</span> <span class="op">~</span> </span>
<span>                 <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">aspect</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span> <span class="op">+</span></span>
<span>                  <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">tpi</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, </span>
<span>               data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">response</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="st">"greater than Lm"</span><span class="op">)</span>, </span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/Tweedie.html" class="external-link">tw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m_mature</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: Tweedie(p=1.269) </span></span>
<span><span class="co">## Link function: log </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## number ~ s(aspect, k = 3, bs = "cr") + s(tpi, k = 3, bs = "cr")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)   </span></span>
<span><span class="co">## (Intercept)   0.6895     0.2203    3.13    0.004 **</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##             edf Ref.df     F p-value  </span></span>
<span><span class="co">## s(aspect) 1.000  1.000 4.192  0.0498 *</span></span>
<span><span class="co">## s(tpi)    1.361  1.591 0.393  0.7185  </span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.021   Deviance explained = 12.7%</span></span>
<span><span class="co">## -REML = 61.763  Scale est. = 2.425     n = 32</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">m_mature</span>, pages <span class="op">=</span> <span class="fl">1</span>, residuals <span class="op">=</span> <span class="cn">T</span>, cex <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="fish-modelling_files/figure-html/set-models-1.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Total abundance</span></span>
<span><span class="va">m_totabund</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">number</span> <span class="op">~</span> </span>
<span>                  <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">detrended</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, </span>
<span>                data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">response</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="st">"total_abundance"</span><span class="op">)</span>, </span>
<span>                family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m_totabund</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: gaussian </span></span>
<span><span class="co">## Link function: identity </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## number ~ s(detrended, k = 3, bs = "cr")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)   131.22      13.24   9.913 5.61e-11 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##              edf Ref.df     F p-value   </span></span>
<span><span class="co">## s(detrended)   1      1 8.602 0.00638 **</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.197   Deviance explained = 22.3%</span></span>
<span><span class="co">## GCV = 5981.2  Scale est. = 5607.4    n = 32</span></span></code></pre>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">m_totabund</span>, pages <span class="op">=</span> <span class="fl">1</span>, residuals <span class="op">=</span> <span class="cn">T</span>, cex <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="fish-modelling_files/figure-html/set-models-2.png" width="700"></p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Species richness</span></span>
<span><span class="va">m_specrich</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html" class="external-link">gam</a></span><span class="op">(</span><span class="va">number</span> <span class="op">~</span> </span>
<span>                    <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html" class="external-link">s</a></span><span class="op">(</span><span class="va">mbdepth</span>, k <span class="op">=</span> <span class="fl">3</span>, bs <span class="op">=</span> <span class="st">"cr"</span><span class="op">)</span>, </span>
<span>                  data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">response</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="st">"species_richness"</span><span class="op">)</span>, </span>
<span>                  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">m_specrich</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Family: gaussian </span></span>
<span><span class="co">## Link function: identity </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Formula:</span></span>
<span><span class="co">## number ~ s(mbdepth, k = 3, bs = "cr")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Parametric coefficients:</span></span>
<span><span class="co">##             Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co">## (Intercept)  13.9688     0.6462   21.62   &lt;2e-16 ***</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Approximate significance of smooth terms:</span></span>
<span><span class="co">##            edf Ref.df     F p-value  </span></span>
<span><span class="co">## s(mbdepth)   1      1 3.904  0.0574 .</span></span>
<span><span class="co">## ---</span></span>
<span><span class="co">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## R-sq.(adj) =  0.0856   Deviance explained = 11.5%</span></span>
<span><span class="co">## GCV = 14.251  Scale est. = 13.36     n = 32</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">m_specrich</span>, pages <span class="op">=</span> <span class="fl">1</span>, residuals <span class="op">=</span> <span class="cn">T</span>, cex <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="fish-modelling_files/figure-html/set-models-3.png" width="700"></p>
<p>Predict each of the response variables across the extent of the
bathymetry derivatives.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">preddf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">preddf</span>, </span>
<span>                <span class="st">"pmature"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m_mature</span>, <span class="va">preddf</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,</span>
<span>                <span class="st">"ptotabund"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m_totabund</span>, <span class="va">preddf</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,</span>
<span>                <span class="st">"pspecrich"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m_specrich</span>, <span class="va">preddf</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 73,350</span></span>
<span><span class="co">## Columns: 12</span></span>
<span><span class="co">## $ x         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 115.1714, 115.1739, 115.1764, 115.1789, 115.1814, 115.1839, …</span></span>
<span><span class="co">## $ y         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -33.60361, -33.60361, -33.60361, -33.60361, -33.60361, -33.6…</span></span>
<span><span class="co">## $ mbdepth   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -14.83014, -13.89184, -14.18757, -14.48647, -14.47323, -14.3…</span></span>
<span><span class="co">## $ slope     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.24350203, 0.19746646, 0.17799167, 0.18316828, 0.22091857, …</span></span>
<span><span class="co">## $ aspect    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 339.995240, 341.597571, 21.180346, 12.600024, 356.337121, 35…</span></span>
<span><span class="co">## $ tpi       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -3.721524e-01, 5.277313e-01, 1.502453e-01, -1.123428e-03, 9.…</span></span>
<span><span class="co">## $ tri       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 0.9656481, 0.8277034, 0.6934198, 0.6945946, 0.8081013, 0.902…</span></span>
<span><span class="co">## $ roughness <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 2.807414, 2.421717, 2.196986, 2.156502, 2.581898, 2.606502, …</span></span>
<span><span class="co">## $ detrended <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -2.871674, -2.161609, -2.683798, -3.207528, -3.417629, -3.56…</span></span>
<span><span class="co">## $ pmature   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 4.6062374, 3.5770040, 0.6489945, 0.6475193, 4.1814433, 4.152…</span></span>
<span><span class="co">## $ ptotabund <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 140.7683, 138.4064, 140.1434, 141.8855, 142.5844, 143.0622, …</span></span>
<span><span class="co">## $ pspecrich <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 17.83208, 17.94093, 17.90662, 17.87195, 17.87349, 17.88257, …</span></span></code></pre>
<p>Save out the spatial predictions. If your computer crashes this way
you don’t need to run the whole script again.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/serialize.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="va">preddf</span>, file <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"r-workflows/model output/fish/"</span>, </span>
<span>                              <span class="va">name</span>, <span class="st">"_fish-prediction.RDS"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Pivot the data to long format for easy plotting.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">preddf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">"p"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>names_to <span class="op">=</span> <span class="st">"response"</span>, values_to <span class="op">=</span> <span class="st">"value"</span>,</span>
<span>               cols <span class="op">=</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://pillar.r-lib.org/reference/glimpse.html" class="external-link">glimpse</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Rows: 220,050</span></span>
<span><span class="co">## Columns: 4</span></span>
<span><span class="co">## $ x        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 115.1714, 115.1714, 115.1714, 115.1739, 115.1739, 115.1739, 1…</span></span>
<span><span class="co">## $ y        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> -33.60361, -33.60361, -33.60361, -33.60361, -33.60361, -33.60…</span></span>
<span><span class="co">## $ response <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> "pmature", "ptotabund", "pspecrich", "pmature", "ptotabund", …</span></span>
<span><span class="co">## $ value    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> 4.6062374, 140.7683476, 17.8320846, 3.5770040, 138.4063509, 1…</span></span></code></pre>
<p>Reset the response variables to loop through when plotting.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">resp.vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">response</span><span class="op">)</span></span></code></pre></div>
<p>Load marine park data. The dataset used here is the 2022
Collaborative Australian Protected Areas Database, which is available
for free download from <a href="https://fed.dcceew.gov.au/datasets/782c02c691014efe8ffbd27445fe41d7_0/explore" class="external-link uri">https://fed.dcceew.gov.au/datasets/782c02c691014efe8ffbd27445fe41d7_0/explore</a>.
Feel free to replace this shapefile with any suitable dataset that is
available for your study area.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">marine.parks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"r-workflows/data/spatial/shapefiles/Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine.shp"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ZONE_TYPE <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html" class="external-link">str_replace_all</a></span><span class="op">(</span><span class="va">ZONE_TYPE</span>, </span>
<span>                                            <span class="st">"\\s*\\([^\\)]+\\)"</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">ZONE_TYPE</span>, <span class="st">"Sanctuary|National Park"</span><span class="op">)</span>,</span>
<span>                <span class="va">STATE</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="st">"WA"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>                        </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine' from data source `/home/runner/work/CheckEM/CheckEM/r-workflows/data/spatial/shapefiles/Collaborative_Australian_Protected_Areas_Database_(CAPAD)_2022_-_Marine.shp' </span></span>
<span><span class="co">##   using driver `ESRI Shapefile'</span></span>
<span><span class="co">## Simple feature collection with 3775 features and 26 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 70.71702 ymin: -58.44947 xmax: 170.3667 ymax: -8.473407</span></span>
<span><span class="co">## Geodetic CRS:  WGS 84</span></span></code></pre>
<p>Loop through each response variable and create a ggplot figure for
each.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">resp.vars</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">use.dat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">response</span> <span class="op"><a href="https://rdrr.io/pkg/terra/man/match.html" class="external-link">%in%</a></span> <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">use.dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradientn</a></span><span class="op">(</span>colours <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#fde725"</span>, <span class="st">"#21918c"</span>, <span class="st">"#440154"</span><span class="op">)</span>, na.value <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://eliocamp.github.io/ggnewscale/reference/new_scale.html" class="external-link">new_scale_fill</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>                     </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">marine.parks</span>, fill <span class="op">=</span> <span class="cn">NA</span>, colour <span class="op">=</span> <span class="st">"#7bbc63"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">0.2</span>, show.legend <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">y</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"gg_"</span>, <span class="va">resp.vars</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, <span class="va">p</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Combine the plots using patchwork.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gg_pmature</span> <span class="op">+</span> <span class="va">gg_ptotabund</span> <span class="op">+</span> <span class="va">gg_pspecrich</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.justification <span class="op">=</span> <span class="st">"left"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="fish-modelling_files/figure-html/combine-fish-plots-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p><img src="https://ardc.edu.au/wp-content/uploads/2022/09/ardc-logo.svg" height="60" alt="ARDC">    <img src="https://www.nespmarinecoastal.edu.au/wp-content/themes/MarineAndCoastalHubTheme/images/logo.svg" height="70" alt="National Environmental Science Program: Marine and Coastal">     Package developed by Brooke Gibbons, Claude Spencer, Tim Langlois.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
